var app=angular.module("mainApp",["ui.router","templates"]);app.config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("home",{url:"/home",templateUrl:"home.html",controller:"MainCtrl",resolve:{userPromise:["users",function(t){return t.getAll()}]}}).state("orders",{url:"/orders",templateUrl:"orders.html",controller:"MainCtrl"}).state("posts",{url:"/posts/{id}",templateUrl:"posts.html",controller:"PostsCtrl",resolve:{post:["$stateParams","posts",function(t,e){return e.get(t.id)}]}}).state("users",{url:"/users/{id}",templateUrl:"users.html",controller:"UserCtrl",resolve:{usersPromise:["users",function(t){return t.get()}]}}),e.otherwise("home")}]),app.controller("MainCtrl",["$scope","users","auth",function(t,e,o){t.users=e.users,t.addPost=function(){t.title&&""!==t.title&&(posts.create({title:t.title,link:t.link}),t.title="",t.link="")},t.incrementUpvotes=function(t){posts.upvote(t)},t.isLoggedIn=o.isLoggedIn}]),app.controller("PostsCtrl",["$scope","posts","post","auth",function(t,e,o,r){t.posts=e.posts,t.post=o,t.addComment=function(){""!==t.body&&(e.addComment(o._id,{body:t.body,author:"user"}).success(function(e){t.post.comments.push(e)}),t.body="")},t.incrementUpvotes=function(t){e.upvoteComment(o,t)}}]),app.controller("UserCtrl",["$scope","users","auth",function(t,e,o){t.users=e.users}]),app.controller("NavCtrl",["$scope","auth",function(t,e){t.isLoggedIn=e.isLoggedIn,t.currentUser=e.currentUser,t.logOut=e.logOut}]),app.factory("posts",["$http","auth",function(t,e){var o={posts:[]};return o.getAll=function(){return t.get("/api/posts").success(function(t){angular.copy(t,o.posts)})},o.create=function(r){return t.post("/api/posts",r,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(t){o.posts.push(t)})},o.upvote=function(o){return t.put("/api/posts/"+o._id+"/upvote",null,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(t){o.upvotes+=1})},o.get=function(e){return t.get("/api/posts/"+e).then(function(t){return t.data})},o.addComment=function(o,r){return t.post("/api/posts/"+o+"/comments",r,{headers:{Authorization:"Bearer "+e.getToken()}})},o.upvoteComment=function(o,r){return t.put("/api/posts/"+o._id+"/comments/"+r._id+"/upvote",null,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(t){r.upvotes+=1})},o}]),app.factory("auth",["$http","$window",function(t,e){var o={};return o.saveToken=function(t){e.localStorage["admin-token"]=t},o.getToken=function(){return e.localStorage["admin-token"]},o.isLoggedIn=function(){var t=o.getToken();if(t){var r=JSON.parse(e.atob(t.split(".")[1]));return r.exp>Date.now()/1e3}return!1},o.currentUser=function(){if(o.isLoggedIn()){var t=o.getToken(),r=JSON.parse(e.atob(t.split(".")[1]));return r.username}},o.logOut=function(){e.localStorage.removeItem("admin-token"),e.location="http://localhost:3000/"},o}]),app.factory("users",["$http","$window",function(t,e){var o={users:[]};return o.getAll=function(){return t.get("/api/users").success(function(t){angular.copy(t,o.users)})},o.get=function(e){return t.get("/api/user/"+e).then(function(t){return t.data})},o}]);