var app=angular.module("mainApp",["ui.router","templates"]);app.config(["$stateProvider","$urlRouterProvider",function(t,o){t.state("home",{url:"/home",templateUrl:"home.html",controller:"MainCtrl",resolve:{postPromise:["posts",function(t){return t.getAll()}]}}).state("orders",{url:"/orders",templateUrl:"orders.html",controller:"MainCtrl"}).state("posts",{url:"/posts/{id}",templateUrl:"posts.html",controller:"PostsCtrl",resolve:{post:["$stateParams","posts",function(t,o){return o.get(t.id)}]}}),o.otherwise("home")}]),app.controller("MainCtrl",["$scope","posts","auth",function(t,o,e){t.posts=o.posts,t.addPost=function(){t.title&&""!==t.title&&(o.create({title:t.title,link:t.link}),t.title="",t.link="")},t.incrementUpvotes=function(t){o.upvote(t)},t.isLoggedIn=e.isLoggedIn}]),app.controller("PostsCtrl",["$scope","posts","post","auth",function(t,o,e,n){t.posts=o.posts,t.post=e,t.addComment=function(){""!==t.body&&(o.addComment(e._id,{body:t.body,author:"user"}).success(function(o){t.post.comments.push(o)}),t.body="")},t.incrementUpvotes=function(t){o.upvoteComment(e,t)}}]),app.controller("NavCtrl",["$scope","auth",function(t,o){t.isLoggedIn=o.isLoggedIn,t.currentUser=o.currentUser,t.logOut=o.logOut}]),app.factory("posts",["$http","auth",function(t,o){var e={posts:[]};return e.getAll=function(){return t.get("/api/posts").success(function(t){angular.copy(t,e.posts)})},e.create=function(n){return t.post("/api/posts",n,{headers:{Authorization:"Bearer "+o.getToken()}}).success(function(t){e.posts.push(t)})},e.upvote=function(e){return t.put("/api/posts/"+e._id+"/upvote",null,{headers:{Authorization:"Bearer "+o.getToken()}}).success(function(t){e.upvotes+=1})},e.get=function(o){return t.get("/api/posts/"+o).then(function(t){return t.data})},e.addComment=function(e,n){return t.post("/api/posts/"+e+"/comments",n,{headers:{Authorization:"Bearer "+o.getToken()}})},e.upvoteComment=function(e,n){return t.put("/api/posts/"+e._id+"/comments/"+n._id+"/upvote",null,{headers:{Authorization:"Bearer "+o.getToken()}}).success(function(t){n.upvotes+=1})},e}]),app.factory("auth",["$http","$window",function(t,o){var e={};return e.saveToken=function(t){o.localStorage["admin-token"]=t},e.getToken=function(){return o.localStorage["admin-token"]},e.isLoggedIn=function(){var t=e.getToken();if(t){var n=JSON.parse(o.atob(t.split(".")[1]));return n.exp>Date.now()/1e3}return!1},e.currentUser=function(){if(e.isLoggedIn()){var t=e.getToken(),n=JSON.parse(o.atob(t.split(".")[1]));return n.username}},e.logOut=function(){o.localStorage.removeItem("admin-token"),o.location="http://localhost:3000/"},e}]);