var app=angular.module("mainApp",["ui.router","templates"]);app.config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("home",{url:"/home",templateUrl:"home.html",controller:"DashCtrl",resolve:{postsPromise:["posts",function(t){return t.getAll()}]}}).state("post",{url:"/post/:post",templateUrl:"post.html",controller:"PostCtrl",resolve:{postPromise:["$stateParams","posts",function(t,e){return e.get(t.post)}]}}).state("shop",{url:"/shop",templateUrl:"shop.html",controller:"ShopCtrl",resolve:{itemPromise:["items",function(t){return t.getAll()}]}}).state("items",{url:"/items/:item",templateUrl:"items.html",controller:"ItemsCtrl",resolve:{item:["$stateParams","items",function(t,e){return e.get(t.id)}]}}).state("diet",{url:"/items/diet/:item",templateUrl:"diet.html",controller:"ItemsCtrl",resolve:{item:["$stateParams","items",function(t,e){return e.get(t.id)}]}}).state("transactions",{url:"/transactions",templateUrl:"transactions.html",controller:"TransCtrl",resolve:{item:["$stateParams","items",function(t,e){return e.get(t.item)}]}}).state("checkout",{url:"/checkout",templateUrl:"checkout.html",controller:"CheckoutCtrl",resolve:{item:["$stateParams","items",function(t,e){return e.get(t.id)}]}}).state("groups",{url:"/groups",templateUrl:"groups.html",controller:"GroupsCtrl",resolve:{groupPromise:["groups",function(t){return t.getAll()}]}}).state("groupHome",{url:"/group/:id",templateUrl:"group_home.html",controller:"GHomeCtrl",resolve:{groupsPromise:["$stateParams","groups",function(t,e){return e.get(t.id)}]}}).state("messenger",{url:"/messenger",templateUrl:"messenger.html",controller:"MessengerCtrl",resolve:{usersPromise:["users",function(t){return t.getAll()}],conversationsPromise:["messenger",function(t){return t.getAll()}]}}).state("settings",{url:"/settings",templateUrl:"settings.html",controller:"SettingsCtrl",resolve:{languagePromise:["languages",function(t){return t.getAll()}],userPromise:["$stateParams","settings",function(t,e){return e.get(t.handle)}]}})}]),app.controller("MainCtrl",["$scope","auth",function(t,e){t.user=e.getUser(),mixpanel.alias(t.user._id),mixpanel.identify(t.user._id),mixpanel.people.set({$email:t.user.username,$last_login:new Date}),t.isLoggedIn=e.isLoggedIn}]),app.controller("DashCtrl",["$scope","posts","auth",function(t,e,n){t.posts=e.posts,t.addPost=function(){t.title&&""!==t.title&&(e.create({title:t.title,link:t.link}),t.title="",t.link="",mixpanel.identify(t.user._id),mixpanel.track("User Dashboard: Add Post"))},t.incrementUpvotes=function(n){e.upvote(n),mixpanel.identify(t.user._id),mixpanel.track("User Dashboard: Upvoted Comment")},t.isLoggedIn=n.isLoggedIn}]),app.controller("PostCtrl",["$scope","auth","posts","postPromise",function(t,e,n,o){t.post=o.data,t.comment={post:t.post._id,body:null,author:t.user.username},t.addComment=function(){t.comment.body&&""!==t.comment.body&&n.addComment(t.post,t.comment).success(function(e){t.post.comments.push(e),t.comment.body=null})},t.incrementUpvotes=function(e){n.upvoteComment(t.post,e)},t.isLoggedIn=e.isLoggedIn}]),app.controller("ShopCtrl",["$scope","items","auth",function(t,e,n){t.items=e.items,t.addItem=function(){e.create(t.item).success(function(n){console.log("success"),t.items=e.items,console.log(n)}).error(function(){console.log("failure")}),mixpanel.identify(t.user._id),mixpanel.track("Shop Page: Added Item")},t.incrementUpvotes=function(n){e.upvoteItem(n),mixpanel.identify(t.user._id),mixpanel.track("Shop Page: Upvoted Comment")}}]),app.controller("ItemsCtrl",["$scope","items","auth",function(t,e,n){t.items=e.items,t.item=e.item,t.incrementUpvotes=function(n){e.upvoteItem(n),mixpanel.identify(t.user._id),mixpanel.track("Items Page: Upvoted Comment")}}]),app.controller("NavCtrl",["$scope","auth",function(t,e){t.isLoggedIn=e.isLoggedIn,t.home=e.isLoggedIn,t.currentUser=e.currentUser,t.logOut=e.logOut}]),app.controller("TransCtrl",["$scope","items","auth","transactions",function(t,e,n,o){t.startTrans=function(){console.log(t.card),o.purchase(t.card),mixpanel.identify(t.user._id),mixpanel.track("Checkout: Purchase Item")}}]),app.controller("SettingsCtrl",["$scope","languages","settings","userPromise",function(t,e,n,o){t.user=angular.extend(t.user,n.settings),t.languages=e.languages,t.addLanguage=function(){console.log(t.language.name),e.addLanguage(t.language.name).success(function(e){t.languages.push(e)})},t.updateSettings=function(){console.log(t.user),n.update(t.user),mixpanel.identify(t.user._id),mixpanel.track("Settings: Update User")},t.user=o.data,console.log(o)}]),app.controller("GroupsCtrl",["$scope","groups","auth",function(t,e,n){t.groups=e.groups,t.addGroup=function(){e.create(t.group),console.log(t.group)},t.group="",t.isLoggedIn=n.isLoggedIn}]),app.controller("GHomeCtrl",["$scope","auth","groupsPromise",function(t,e,n){t.group=n.data,console.log(n.data),t.isLoggedIn=e.isLoggedIn}]),app.controller("GpostCtrl",["$scope","$stateParams","gposts","gcomments","auth",function(t,e,n,o,s){var r=n.gpost[e.id];t.get(r._id),t.gpost=n.gpost,t.gcomments=o.gcomments,t.addGroupComment=function(){scope.body&&""!==t.body&&(n.addGroupComment(n.gpost._id,{body:t.body,author:"user"}).success(function(e){t.gpost.gcomments.push(e)}),t.body="")},t.incrementUpvotes=function(t){n.upvoteGroupComment(r,t)},t.isLoggedIn=s.isLoggedIn}]),app.factory("posts",["$http","auth",function(t,e){var n={posts:[],post:{}};return n.getAll=function(){return t.get("/api/posts").success(function(t){angular.copy(t,n.posts)})},n.create=function(o){return t.post("/api/posts",o,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(t){n.posts.push(t)})},n.upvote=function(n){return t.put("/api/post/"+n._id+"/upvote",null,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(t){n.upvotes+=1})},n.get=function(e){return t.get("/api/post/"+e).success(function(t){return t})},n.addComment=function(n,o){return console.log(n,o),t.post("/api/post/"+n._id+"/comments",o,{headers:{Authorization:"Bearer "+e.getToken()}})},n.upvoteComment=function(n,o){return t.put("/api/post/"+n._id+"/comment/"+o._id+"/upvote",null,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(t){o.upvotes+=1})},n}]),app.factory("comments",["$http","auth",function(t,e){var n={comments:[]};return n.getAll=function(){return t.get("/api/comments").success(function(t){angular.copy(t,n.comments)})},n}]),app.factory("items",["$http","auth",function(t,e){var n={items:[],item:{},videos:[],video:{},books:[],book:{}};return n.getAll=function(){return t.get("/api/items").success(function(t){angular.copy(t,n.items)})},n.getAllVideos=function(){return t.get("/api/videos").success(function(t){angular.copy(t,n.videos)})},n.create=function(o){return t.post("/api/items",o,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(t){var e=angular.extend(t,o);n.items.push(e),n[o.type+"s"].push(e)})},n.get=function(e){return t.get("/api/items/"+e).then(function(t){return t.data})},n.upvote=function(n){return t.put("/api/items/"+n._id+"/upvote",null,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(t){n.upvotes+=1})},n.addTransaction=function(e,n){return t.post("/api/items/"+e+"/transactions",n,{headers:{Authorization:"Bearer "+transactions.getToken()}}).success(function(t){transactions.push(t)})},n}]),app.factory("transactions",["$http","auth",function(t,e){var n={transactions:[]};return n.get=function(e){return t.get("/api/transactions/"+e).then(function(t){return t.data})},n.purchase=function(n){return console.log(n),t.post("api/transactions",{headers:{Authorization:"Bearer "+e.getToken()}})},n}]),app.factory("customers",["$http","auth",function(t,e){var n={customers:[]};return n.get=function(e){return t.get("/api/customers/"+e).then(function(t){return t.data})},n}]),app.factory("auth",["$http","$window",function(t,e){var n={};return n.saveToken=function(t){e.localStorage["admin-token"]=t},n.getToken=function(){return e.localStorage["admin-token"]},n.isLoggedIn=function(){var t=n.getToken();if(t){var o=JSON.parse(e.atob(t.split(".")[1]));return o.exp>Date.now()/1e3}return!1},n.currentUser=function(){if(n.isLoggedIn()){var t=n.getToken(),o=JSON.parse(e.atob(t.split(".")[1]));return o.username}},n.logOut=function(){e.localStorage.removeItem("admin-token"),e.location="http://localhost:3000"},n.getUser=function(){if(n.isLoggedIn()){var t=n.getToken(),o=JSON.parse(e.atob(t.split(".")[1]));return o}},n}]),app.factory("languages",["$http","$window",function(t,e){var n={languages:[]};return n.getAll=function(){return t.get("/api/languages").success(function(t){console.log(t),angular.copy(t,n.languages)})},n.addLanguage=function(e){return console.log(e),t.post("/api/languages",{name:e}).success(function(t){console.log(t),n.languages.push(t)})},n}]),app.factory("settings",["$http","$window",function(t,e){var n={settings:{}};return n.getAll=function(){return t.get("/api/settings").success(function(t){angular.copy(t,n.settings)})},n.update=function(e){return console.log("updating user",e),t.put("/api/settings",e).success(function(t){n.settings=t})},n.get=function(e){return t.get("/api/user/handle/"+e).success(function(t){return console.log(t),t})},n}]),app.factory("users",["$http","$window","auth",function(t,e,n){var o={users:[]};return o.getAll=function(){return t.get("/api/users").success(function(t){angular.copy(t,o.users)})},o.getRange=function(e,o){return console.log(n.getToken()),t.get("/api/users/"+e+"/"+o,{headers:{Authorization:"Bearer "+n.getToken()}})},o.search=function(e){return t.get("/api/users/search/"+e).success(function(t){return t})},o}]),app.factory("groups",["$http","auth",function(t,e){var n={groups:[],group:{}};return n.getAll=function(){return t.get("/api/groups").success(function(t){console.log(t),angular.copy(t,n.groups)})},n.create=function(e){return console.log(e),t.post("/api/groups",e).success(function(t){console.log(t),n.groups.push(t)})},n.get=function(e){return t.get("/api/group/"+e).then(function(t){return console.log(t),t})},n}]),app.factory("gposts",["$http","auth",function(t,e){var n={gposts:[],gpost:{}};return n.getAll=function(){return t.get("/api/gposts").success(function(t){angular.copy(t,n.gposts)})},n.create=function(o){return t.post("/api/gposts",o,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(t){n.gposts.push(t)})},n.upvote=function(n){return t.put("/api/gposts/"+post._id+"/upvote",null,{headers:{Authorization:"Bearer "+e.getToken()}}).success(function(t){n.upvotes+=1})},n.get=function(e){return t.get("/api/gposts/"+e).then(function(t){return t.data})},n.addGroupComment=function(n,o){return t.post("/api/gposts/"+n+"/gcomments",o,{headers:{Authorization:"Bearer "+e.getToken()}})},n}]),app.factory("gcomments",["$http","auth",function(t,e){var n={gcomments:[]};return n.getAll=function(){return t.get("/api/gcomments").success(function(t){angular.copy(t,n.gcomments)})},n}]);