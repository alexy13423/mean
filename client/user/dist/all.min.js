var app=angular.module("mainApp",["ui.router","templates","btford.socket-io"]);app.config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("home",{url:"/home",templateUrl:"home.html",controller:"DashCtrl",resolve:{postsPromise:["posts",function(e){return e.getAll()}]}}).state("post",{url:"/post/:post",templateUrl:"post.html",controller:"PostCtrl",resolve:{postPromise:["$stateParams","posts",function(e,t){return t.get(e.post)}]}}).state("shop",{url:"/shop",templateUrl:"shop.html",controller:"ShopCtrl",resolve:{itemPromise:["items",function(e){return e.getAll()}],userPromise:["$stateParams","users",function(e,t){return t.get(e.id)}]}}).state("items",{url:"/items/:item",templateUrl:"items.html",controller:"ItemsCtrl",resolve:{itemPromise:["$stateParams","items",function(e,t){return console.log(e),t.get(e.item)}]}}).state("diet",{url:"/items/:id/diet/",templateUrl:"diet.html",controller:"ItemsCtrl",resolve:{itemPromise:["$stateParams","items",function(e,t){return console.log(e.id),t.get(e.id)}]}}).state("challenge",{url:"/items/challenge/:id",templateUrl:"challenge.html",controller:"ItemsCtrl",resolve:{itemPromise:["$stateParams","items",function(e,t){return console.log(e.id),t.get(e.id)}]}}).state("transactions",{url:"/transactions",templateUrl:"transactions.html",controller:"TransCtrl",resolve:{item:["$stateParams","items",function(e,t){return t.get(e.item)}]}}).state("checkout",{url:"/checkout",templateUrl:"checkout.html",controller:"CheckoutCtrl",resolve:{item:["$stateParams","items",function(e,t){return t.get(e.id)}]}}).state("groups",{url:"/groups",templateUrl:"groups.html",controller:"GroupsCtrl",resolve:{groupPromise:["groups",function(e){return e.getAll()}]}}).state("groupHome",{url:"/group/:id",templateUrl:"group_home.html",controller:"GHomeCtrl",resolve:{groupsPromise:["$stateParams","groups",function(e,t){return t.get(e.id)}],gpostsPromise:["$stateParams","gposts",function(e,t){return t.getAll(e.id)}]}}).state("messenger",{url:"/messenger",templateUrl:"messenger.html",controller:"MessengerCtrl",resolve:{userPromise:["auth","users",function(e,t){var n=e.isThisUser();return t.get(n)}],usersPromise:["users",function(e){return e.getAll()}],conversationsPromise:["messenger",function(e){return e.getAll()}]}}).state("settings",{url:"/settings/:id",templateUrl:"settings.html",controller:"SettingsCtrl",resolve:{languagePromise:["languages",function(e){return e.getAll()}],userPromise:["$stateParams","users",function(e,t){return t.get(e.id)}]}}).state("user",{url:"/user/:handle",templateUrl:"users.html",controller:"UserCtrl",resolve:{userPromise:["$stateParams","users",function(e,t){return t.get(e.id)}]}})}]),app.controller("MainCtrl",["$scope","auth",function(e,t){e.user=t.getUser(),mixpanel.alias(e.user._id),mixpanel.identify(e.user._id),mixpanel.people.set({$email:e.user.username,$last_login:new Date}),e.isLoggedIn=t.isLoggedIn,e.isUser=t.isUser,e.isAdmin=t.isAdmin,e.logOut=t.logOut,e.isThisUser=t.isThisUser}]),app.controller("DashCtrl",["$scope","posts","auth",function(e,t,n){e.posts=t.posts,e.addPost=function(){e.title&&""!==e.title&&(t.create({title:e.title,link:e.link}),e.title="",e.link="",mixpanel.identify(e.user._id),mixpanel.track("Add Post",{area:"group",page:"groupHome",action:"create"}))},e.incrementUpvotes=function(n){t.upvote(n),mixpanel.identify(e.user._id),mixpanel.track("Upvote Post",{area:"group",page:"groupHome",action:"upvote"})},e.isLoggedIn=n.isLoggedIn,e.isAdmin=n.isAdmin,e.isUser=n.isUser}]),app.controller("PostCtrl",["$scope","auth","posts","postPromise",function(e,t,n,s){e.post=s.data,e.comment={post:e.post._id,body:null,author:e.user.username},e.addComment=function(){e.comment.body&&""!==e.comment.body&&(n.addComment(e.post,e.comment).success(function(t){e.post.comments.push(t),e.comment.body=null}),e.body="",mixpanel.identify(e.user._id),mixpanel.track("Add Comment",{area:"group",page:"groupHome",action:"comment"}))},e.incrementUpvotes=function(t){n.upvoteComment(post,t),mixpanel.identify(e.user._id),mixpanel.track("Upvote Comment",{area:"group",page:"groupHome",action:"upvote"})},e.incrementUpvotes=function(t){n.upvoteComment(e.post,t)},e.isLoggedIn=t.isLoggedIn,e.isAdmin=t.isAdmin,e.isUser=t.isUser}]),app.controller("ShopCtrl",["$scope","items","auth","userPromise",function(e,t,n,s){e.items=t.items,e.user=s,e.addItem=function(){t.create(e.item).success(function(n){console.log("success"),e.items=t.items,console.log(n)}).error(function(){console.log("failure")}),mixpanel.identify(e.user._id),mixpanel.track("Add Item",{area:"shop",page:"shop",action:"create"})},e.incrementUpvotes=function(n){t.upvoteItem(n),mixpanel.identify(e.user._id),mixpanel.track("Upvote Item",{area:"shop",page:"shop",action:"upvote"})},e.isAdmin=n.isAdmin,e.isUser=n.isUser}]),app.controller("ItemsCtrl",["$scope","items","auth","$stateParams","itemPromise",function(e,t,n,s,o){e.items=t.items,e.item=o,e.createDay=function(){t.newDay(s.id,e.day.day).success(function(t){e.item.days.push(t)})},e.incrementUpvotes=function(n){t.upvoteItem(n),mixpanel.identify(e.user._id),mixpanel.track("Upvote Item",{area:"shop",page:"shop",action:"upvote"})},e.isAdmin=n.isAdmin,e.isUser=n.isUser}]),app.controller("NavCtrl",["$scope","auth",function(e,t){e.isLoggedIn=t.isLoggedIn,e.home=t.isLoggedIn,e.currentUser=t.currentUser,e.logOut=t.logOut}]),app.controller("TransCtrl",["$scope","items","auth","transactions",function(e,t,n,s){e.startTrans=function(){console.log(e.card),s.purchase(e.card),mixpanel.identify(e.user._id),mixpanel.track("Start Transaction",{area:"shop",page:"transactions",action:"transaction"})},e.isAdmin=n.isAdmin,e.isUser=n.isUser}]),app.controller("SettingsCtrl",["$scope","languages","settings","userPromise","auth",function(e,t,n,s,o){e.user=angular.extend(e.user,n.settings),e.languages=t.languages,e.addLanguage=function(){console.log(e.language.name),t.addLanguage(e.language.name).success(function(t){e.languages.push(t)}),mixpanel.identify(e.user._id),mixpanel.track("Add Languange",{area:"settings",page:"settings",action:"add"})},e.updateSettings=function(){console.log(e.user),n.update(e.user),mixpanel.identify(e.user._id),mixpanel.track("Settings update",{area:"settings",page:"settings",action:"update"})},e.user=s.data,console.log(s),e.isAdmin=o.isAdmin,e.isUser=o.isUser,e.isThisUser=o.isThisUser}]),app.controller("GroupsCtrl",["$scope","groups","auth",function(e,t,n){e.groups=t.groups,e.addGroup=function(){t.create(e.group),console.log(e.group),mixpanel.identify(e.user._id),mixpanel.track("Add Group",{area:"group",page:"groups",action:"create"})},e.group="",e.isLoggedIn=n.isLoggedIn,e.isAdmin=n.isAdmin,e.isUser=n.isUser}]),app.controller("GHomeCtrl",["$scope","auth","groups","gposts","gcomments","groupsPromise","$stateParams",function(e,t,n,s,o,r,i){n.group[i.id],s.gpost[i.id];e.group=r.data,console.log(r.data),e.currentUser=t.currentUser(),e.groups=n.groups,e.gposts=s.gposts,e.gcomments=o.gcomments,e.addGpost=function(){n.createGpost(e.group,e.gpost).success(function(t){e.group.gposts.push(t),e.gpost.body=null}),mixpanel.identify(e.user._id),mixpanel.track("Add Post",{area:"group",page:"groupHome",action:"create"})},e.addGcomment=function(t){console.log(t),console.log(e.gcomment)},e.isAdmin=t.isAdmin,e.isUser=t.isUser,e.isLoggedIn=t.isLoggedIn}]),app.controller("GpostCtrl",["$scope","$stateParams","gposts","gcomments","auth",function(e,t,n,s,o){var r=n.gpost[t.id];e.get(r._id),e.gpost=n.gpost,e.gcomments=s.gcomments,e.addGcomment=function(){scope.body&&""!==e.body&&(n.addGcomment(n.gpost._id,{body:e.body,author:"user"}).success(function(t){e.gpost.gcomments.push(t)}),e.body="")},e.incrementUpvotes=function(e){n.upvoteGroupComment(r,e)},e.isLoggedIn=o.isLoggedIn,e.isAdmin=o.isAdmin,e.isUser=o.isUser}]),app.factory("posts",["$http","auth",function(e,t){var n={posts:[],post:{}};return n.getAll=function(){return e.get("/api/posts").success(function(e){angular.copy(e,n.posts)})},n.create=function(t){return console.log(t),e.post("/api/posts",t).success(function(e){n.posts.push(e)})},n.upvote=function(n){return e.put("/api/post/"+n._id+"/upvote",null,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){n.upvotes+=1})},n.get=function(t){return e.get("/api/posts/"+t).then(function(e){return console.log(e),e})},n.addComment=function(n,s){return console.log(n,s),e.post("/api/post/"+n._id+"/comments",s,{headers:{Authorization:"Bearer "+t.getToken()}})},n.upvoteComment=function(n,s){return e.put("/api/post/"+n._id+"/comment/"+s._id+"/upvote",null,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){s.upvotes+=1})},n}]),app.factory("comments",["$http","auth",function(e,t){var n={comments:[]};return n.getAll=function(){return e.get("/api/comments").success(function(e){angular.copy(e,n.comments)})},n}]),app.factory("items",["$http","auth",function(e,t){var n={items:[],item:{},videos:[],video:{},books:[],book:{}};return n.getAll=function(){return e.get("/api/items").success(function(e){angular.copy(e,n.items)})},n.getAllVideos=function(){return e.get("/api/videos").success(function(e){angular.copy(e,n.videos)})},n.create=function(s){return e.post("/api/items",s,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){var t=angular.extend(e,s);n.items.push(t),n[s.type+"s"].push(t)})},n.newDay=function(t,n){return e.post("/api/items/"+t+"/diet",n).success(function(e){return e})},n.get=function(t){return e.get("/api/items/"+t).then(function(e){return e.data})},n.upvote=function(n){return e.put("/api/items/"+n._id+"/upvote",null,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){n.upvotes+=1})},n.addTransaction=function(t,n){return e.post("/api/items/"+t+"/transactions",n,{headers:{Authorization:"Bearer "+transactions.getToken()}}).success(function(e){transactions.push(e)})},n}]),app.factory("transactions",["$http","auth",function(e,t){var n={transactions:[]};return n.get=function(t){return e.get("/api/transactions/"+t).then(function(e){return e.data})},n.purchase=function(n){return console.log(n),e.post("api/transactions",{headers:{Authorization:"Bearer "+t.getToken()}})},n}]),app.factory("customers",["$http","auth",function(e,t){var n={customers:[]};return n.get=function(t){return e.get("/api/customers/"+t).then(function(e){return e.data})},n}]),app.factory("auth",["$http","$window",function(e,t){var n={};return n.saveToken=function(e){t.localStorage["admin-token"]=e},n.getToken=function(){return t.localStorage["admin-token"]},n.isLoggedIn=function(){var e=n.getToken();if(e){var s=JSON.parse(t.atob(e.split(".")[1]));return s.exp>Date.now()/1e3}return!1},n.currentUser=function(){if(n.isLoggedIn()){var e=n.getToken(),s=JSON.parse(t.atob(e.split(".")[1]));return s.username}},n.isThisUser=function(){if(n.isLoggedIn()){var e=n.getToken(),s=JSON.parse(t.atob(e.split(".")[1]));return s._id}},n.isUser=function(){var e=n.getToken();if(e){var s=JSON.parse(t.atob(e.split(".")[1]));return"User"===s.permissions||"Admin"||"Collaborator"}return!1},n.isAdmin=function(){var e=n.getToken();if(e){var s=JSON.parse(t.atob(e.split(".")[1]));return"Admin"===s.permissions}return!1},n.logOut=function(){t.localStorage.removeItem("admin-token"),t.location="http://localhost:3000"},n.getUser=function(){if(n.isLoggedIn()){var e=n.getToken(),s=JSON.parse(t.atob(e.split(".")[1]));return s}},n}]),app.factory("languages",["$http","$window",function(e,t){var n={languages:[]};return n.getAll=function(){return e.get("/api/languages").success(function(e){console.log(e),angular.copy(e,n.languages)})},n.addLanguage=function(t){return console.log(t),e.post("/api/user/:id/languages",{name:t}).success(function(e){console.log(e),n.languages.push(e)})},n}]),app.factory("settings",["$http","$window",function(e,t){var n={settings:{}};return n.getAll=function(){return e.get("/api/settings").success(function(e){angular.copy(e,n.settings)})},n.update=function(t){return console.log("updating user",t),e.put("/api/settings",t).success(function(e){n.settings=e})},n.uploadAvatar=function(e){},n.get=function(t){return e.get("/api/user/handle/"+t).success(function(e){return console.log(e),e})},n}]),app.factory("users",["$http","$window","auth",function(e,t,n){var s={users:[],user:{}};return s.getAll=function(){return e.get("/api/users").success(function(e){angular.copy(e,s.users)})},s.getRange=function(t,s){return e.get("/api/users/"+t+"/"+s,{headers:{Authorization:"Bearer "+n.getToken()}})},s.search=function(t){return e.get("/api/users/search/"+t).success(function(e){return e})},s.get=function(t){return e.get("/api/user/"+t).success(function(e){return console.log(e),e})},s.update=function(t){return console.log("updating user",t),e.put("/api/settings",t).success(function(e){s.users=e})},s.get=function(t){return e.get("/api/user/"+t).success(function(e){return s.user=e,e})},s.getAllButSelf=function(){var e=s.users;return angular.forEach(e,function(t,s){t.username===n.currentUser()&&e.splice(s,1)}),e},s}]),app.factory("groups",["$http","auth",function(e,t){var n={groups:[],group:{}};return n.getAll=function(){return e.get("/api/groups").success(function(e){console.log(e),angular.copy(e,n.groups)})},n.create=function(t){return console.log(t),e.post("/api/groups",t).success(function(e){console.log(e),n.groups.push(e)})},n.get=function(t){return e.get("/api/group/"+t).then(function(e){return console.log(e),e})},n.createGpost=function(n,s){return console.log(n,s),e.post("/api/group/"+n._id+"/gposts",s,{headers:{Authorization:"Bearer "+t.getToken()}})},n.createGcomment=function(e,t){console.log(e),console.log(t)},n}]),app.factory("gposts",["$http","auth",function(e,t){var n={gposts:[],gpost:{}};return n.getAll=function(t){return e.get("/api/group/"+t+"/gposts").success(function(e){console.log(e),angular.copy(e,n.gposts)})},n}]),app.factory("gcomments",["$http","auth",function(e,t){var n={gcomments:[]};return n.getAll=function(){return e.get("/api/gcomments").success(function(e){angular.copy(e,n.gcomments)})},n}]),app.controller("MessengerCtrl",["$scope","settings","users","messenger","messageSocket","Conversation","Message",function(e,t,n,s,o,r,i){function a(t){e.mainConversation=t,e.newmessage.conversation=t._id,t["new"]||s.readMessages(t)}function u(){o.emit("message",e.user.handle,e.newmessage.body),s.postMessage(e.mainConversation,e.newmessage).then(function(t){e.mainConversation.messages.push(t),e.mainConversation.latest=t,e.newmessage.body=null},function(e){}),e.addUserModal=!1}e.debug=!0,e.users=n.getAllButSelf(),angular.extend(e.user,n.user),e.newmessage=new i(e.user),e.conversations=s.conversations||[],e.conversations.length>0&&(e.debug&&console.log("we got a convo to see"),a(e.conversations[0])),e.focusConversation=a,e.initConversation=function(){e.debug&&console.log("main convo",!!e.mainConversation),e.mainConversation&&e.mainConversation["new"]||(e.addUserModal=!0,e.conversations.unshift(new r),e.focusConversation(e.conversations[0]),e.mainConversation.users.push(e.user))},e.cancelNewConversation=function(){e.conversations.splice(0,1),e.focusConversation(e.conversations[0])},e.searchUsers=function(){n.search(e.conversation.userQuery).success(function(t){e.conversation.userResult=t,e.debug&&console.log(e.conversation)})},e.addToConversation=function(t){e.mainConversation.users.push(t)},e.sendMessage=function(){e.mainConversation._id?u():s.createConversation(e.mainConversation).then(function(t){e.mainConversation._id=t._id,u()})},e.$on("socket:broadcast",function(t,n){return console.log("got a message",t.name,n),n.payload?void e.$apply(function(){}):void console.log("invalid message | event",t,"data",JSON.stringify(n))}),e.isSelf=function(t){return t===e.user._id},e.otherPeople=function(t){var n=angular.copy(t.users,n);return angular.forEach(n,function(t,s){e.isSelf(t._id)&&n.splice(s,1)}),angular.forEach(n,function(e,t){n[t]=e.f_name+" "+e.l_name}),n.join(", ")}}]),app.directive("conversationAddUsers",function(){return{restrict:"E",controller:"MessengerCtrl",scope:!1,template:'<div class="col-sm-12"><div ng-repeat="user in users | orderBy:\'username\'" ng-click="addToConversation(user)"><i class="fa fa-plus"></i> {{user.handle || user.username}} {{user.f_name + \' \' + user.l_name}}</div><div class="col-sm-12" ng-repeat="user in conversation.userResult"><div class="col-sm-1">Pic</div><div class="col-sm-10">{{user.handle}} | {{user.f_name}} {{user.l_name}}</div><div class="col-sm-1"> </div></div></div>',link:function(e,t,n){}}}),app.directive("messageBox",function(){return{restrict:"EA",controller:["$scope","$element",function(e,t){e.$watch("messageLog",function(){var e=t[0].children[0];e.scrollTop=e.scrollHeight})}]}}),app.factory("messenger",["$http","auth",function(e,t){var n={conversations:[]};return n.getAll=function(){return e.get("/api/conversations",{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){console.log(e),angular.copy(e,n.conversations)})},n.get=function(t){return e.get("/api/conversation/"+t).success(function(e){return e})},n.createConversation=function(n){return e.post("/api/conversation",n,{headers:{Authorization:"Bearer "+t.getToken()}}).then(function(e){return e.data})},n.postMessage=function(n,s){return console.log("convo",n,"message",s.body,s),e.post("/api/conversation/"+n._id+"/messages",s,{headers:{Authorization:"Bearer "+t.getToken()}}).then(function(e){return e.data})},n.readMessages=function(n){return console.log("reading messages"),e.put("/api/conversation/"+n._id+"/read",{user:t.getUser()._id},{headers:{Authorization:"Bearer "+t.getToken()}})},n}]),app.factory("Conversation",function(){var e=function(){var e=this;e.users=[],e.messages=[],e["new"]=!0};return e}),app.factory("Message",function(){var e=function(e){var t=this;t.user=e._id||null,t.f_name=e.f_name||null,t.l_name=e.l_name||null,t.handle=e.handle||null};return e}),app.factory("messageSocket",["socketFactory",function(e){var t=e();return t.forward("broadcast"),t}]);