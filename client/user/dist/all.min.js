<<<<<<< HEAD
var app=angular.module("mainApp",["ui.router","templates","btford.socket-io"]);app.config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("home",{url:"/home",templateUrl:"home.html",controller:"DashCtrl",resolve:{postsPromise:["posts",function(e){return e.getAll()}]}}).state("post",{url:"/post/:post",templateUrl:"post.html",controller:"PostCtrl",resolve:{postPromise:["$stateParams","posts",function(e,t){return t.get(e.post)}]}}).state("shop",{url:"/shop",templateUrl:"shop.html",controller:"ShopCtrl",resolve:{itemPromise:["items",function(e){return e.getAll()}]}}).state("events",{url:"/events",templateUrl:"events.html",controller:"ShopCtrl",resolve:{itemPromise:["$stateParams","items",function(e,t){return console.log(e),t.get(e.item)}]}}).state("item",{url:"/item/:id",templateUrl:"item.html",controller:"ItemCtrl",resolve:{itemPromise:["$stateParams","items",function(e,t){return t.get(e.id)}]}}).state("challenge",{url:"/items/challenge/:id",templateUrl:"challenge.html",controller:"ItemsCtrl",resolve:{itemPromise:["$stateParams","items",function(e,t){return console.log(e.id),t.get(e.id)}]}}).state("workoutPlan",{url:"/items/workoutplan/:id",templateUrl:"workoutPlan.html",controller:"ItemsCtrl",resolve:{itemPromise:["$stateParams","items",function(e,t){return console.log(e.id),t.get(e.id)}]}}).state("exerciseSteps",{url:"/items/exercise/:exercise",templateUrl:"exerciseSteps.html",controller:"ExerciseCtrl",resolve:{exercisePromise:["$stateParams","items",function(e,t){return console.log(e.exercise),t.getExercise(e.exercise)}]}}).state("stepConsumption",{url:"/items/step/:step",templateUrl:"stepConsumption.html",controller:"StepCtrl",resolve:{stepPromise:["$stateParams","items",function(e,t){return console.log(e.step),t.getStep(e.step)}]}}).state("transactions",{url:"/transactions/:item",templateUrl:"transactions.html",controller:"TransCtrl",resolve:{itemPromise:["$stateParams","items",function(e,t){return t.get(e.item)}]}}).state("checkout",{url:"/checkout",templateUrl:"checkout.html",controller:"CheckoutCtrl",resolve:{item:["$stateParams","items",function(e,t){return t.get(e.id)}]}}).state("groups",{url:"/groups",templateUrl:"groups.html",controller:"GroupsCtrl",resolve:{groupPromise:["groups",function(e){return e.getAll()}]}}).state("groupHome",{url:"/group/:id",templateUrl:"group_home.html",controller:"GHomeCtrl",resolve:{groupsPromise:["$stateParams","groups",function(e,t){return t.get(e.id)}]}}).state("messenger",{url:"/messenger",templateUrl:"messenger.html",controller:"MessengerCtrl",resolve:{usersPromise:["users",function(e){return e.getAll()}],conversationsPromise:["messenger",function(e){return e.getAll()}]}}).state("settings",{url:"/settings/:id",templateUrl:"settings.html",controller:"SettingsCtrl",resolve:{languagePromise:["languages",function(e){return e.getAll()}],userPromise:["$stateParams","users",function(e,t){return t.get(e.id)}]}}).state("user",{url:"/user/:handle",templateUrl:"users.html",controller:"UserCtrl",resolve:{userPromise:["$stateParams","users",function(e,t){return t.get(e.id)}]}}),t.otherwise("home")}]),app.controller("MainCtrl",["$scope","auth","messageSocket",function(e,t,n){e.user=t.getUser(),mixpanel.alias(e.user._id),mixpanel.identify(e.user._id),mixpanel.people.set({$email:e.user.username,$last_login:new Date}),e.isLoggedIn=t.isLoggedIn,e.isUser=t.isUser,e.isContributor=t.isContributor,e.isAdmin=t.isAdmin,e.logOut=t.logOut,e.isThisUser=t.isThisUser,e.$on("socket:tokenrequest",function(e,o){console.log("socket:tokenrequest",e.name,o),console.log(o.message),n.emit("authenticate",{token:t.getToken()})}),e.$on("socket:broadcast",function(e,t){console.log("broadcast to socket",e.name,t)})}]),app.controller("DashCtrl",["$scope","posts","auth",function(e,t,n){e.posts=t.posts,e.addPost=function(){e.title&&""!==e.title&&(t.create({title:e.title,link:e.link}),e.title="",e.link="",mixpanel.identify(e.user._id),mixpanel.track("Add Post",{area:"group",page:"groupHome",action:"create"}))},e.incrementUpvotes=function(n){t.upvote(n),mixpanel.identify(e.user._id),mixpanel.track("Upvote Post",{area:"group",page:"groupHome",action:"upvote"})},e.isLoggedIn=n.isLoggedIn,e.isAdmin=n.isAdmin,e.isUser=n.isUser}]),app.controller("PostCtrl",["$scope","auth","posts","postPromise",function(e,t,n,o){e.post=o.data,e.comment={post:e.post._id,body:null,author:e.user.username},e.addComment=function(){e.comment.body&&""!==e.comment.body&&(n.addComment(e.post,e.comment).success(function(t){e.post.comments.push(t),e.comment.body=null}),e.body="",mixpanel.identify(e.user._id),mixpanel.track("Add Comment",{area:"group",page:"groupHome",action:"comment"}))},e.incrementUpvotes=function(t){n.upvoteComment(post,t),mixpanel.identify(e.user._id),mixpanel.track("Upvote Comment",{area:"group",page:"groupHome",action:"upvote"})},e.incrementUpvotes=function(t){n.upvoteComment(e.post,t)},e.isLoggedIn=t.isLoggedIn,e.isAdmin=t.isAdmin,e.isUser=t.isUser}]),app.controller("ShopCtrl",["$scope","items","auth",function(e,t,n){e.items=t.items,e.addItem=function(){t.create(e.item).success(function(n){console.log("success"),e.items=t.items,e.item=new Item,console.log(n)}).error(function(){console.log("failure")}),mixpanel.identify(e.user._id),mixpanel.track("Add Item",{area:"shop",page:"shop",action:"create"})},e.itemTitles={workoutplan:"Workout Plan",dietplan:"Diet Plan",book:"Book",video:"Video",podcast:"Podcast",bootcamp:"Bootcamp",challenge:"Online Challenge"},e.incrementUpvotes=function(n){t.upvoteItem(n),mixpanel.identify(e.user._id),mixpanel.track("Upvote Item",{area:"shop",page:"shop",action:"upvote"})},e.editItem=function(t){e.item=t},e.isAdmin=n.isAdmin,e.isUser=n.isUser}]),app.controller("ItemCtrl",["$scope","items","auth","$stateParams","itemPromise",function(e,t,n,o,s){e.items=t.items,e.item=s.data,item=s,e.deleteItem=function(){console.log(item._id),t["delete"](e.item._id).success(function(n){console.log("success"),e.items=t.items,console.log(n)})},e.createDay=function(){t.newDay(o.id,e.day.day).success(function(t){e.item.days.push(t)})},e.incrementUpvotes=function(n){t.upvoteItem(n),mixpanel.identify(e.user._id),mixpanel.track("Upvote Item",{area:"shop",page:"shop",action:"upvote"})},e.isAdmin=n.isAdmin,e.isUser=n.isUser,e.addPlan=function(){t.newPlan(e.workoutPlan,o.id).success(function(t){console.log("success"),e.item.exercises.push(t)}).error(function(){console.log("failure")})}}]),app.controller("ExerciseCtrl",["$scope","items","exercisePromise","$stateParams",function(e,t,n,o){e.exercise=n,e.addStep=function(){t.newStep(e.step,o.exercise).success(function(t){console.log("success"),e.step=null,e.exercise.steps.push(t)}).error(function(){console.log("failure")})}}]),app.controller("StepCtrl",["$scope","items","stepPromise","$stateParams",function(e,t,n,o){e.step=n}]),app.controller("NavCtrl",["$scope","auth",function(e,t){e.isLoggedIn=t.isLoggedIn,e.home=t.isLoggedIn,e.currentUser=t.currentUser,e.logOut=t.logOut}]),app.controller("TransCtrl",["$scope","items","auth","transactions","itemPromise",function(e,t,n,o,s){e.item=s.data,e.startTrans=function(){console.log(e.item),o.purchase(e.item),mixpanel.identify(e.user._id),mixpanel.track("Start Transaction",{area:"shop",page:"transactions",action:"transaction"})},e.isAdmin=n.isAdmin,e.isUser=n.isUser}]),app.controller("SettingsCtrl",["$scope","languages","settings","userPromise","auth",function(e,t,n,o,s){e.user=angular.extend(e.user,n.settings),e.languages=t.languages,e.addLanguage=function(){console.log(e.language.name),t.addLanguage(e.language.name).success(function(t){e.languages.push(t)}),mixpanel.identify(e.user._id),mixpanel.track("Add Languange",{area:"settings",page:"settings",action:"add"})},e.updateSettings=function(){console.log(e.user),n.update(e.user),mixpanel.identify(e.user._id),mixpanel.track("Settings update",{area:"settings",page:"settings",action:"update"})},e.user=o.data,console.log(o),e.isAdmin=s.isAdmin,e.isUser=s.isUser,e.isThisUser=s.isThisUser}]),app.controller("GroupsCtrl",["$scope","groups","auth",function(e,t,n){e.groups=t.groups,e.addGroup=function(){t.create(e.group),console.log(e.group),mixpanel.identify(e.user._id),mixpanel.track("Add Group",{area:"group",page:"groups",action:"create"})},e.group="",e.isLoggedIn=n.isLoggedIn,e.isAdmin=n.isAdmin,e.isUser=n.isUser}]),app.controller("GHomeCtrl",["$scope","auth","groups","gposts","gcomments","groupsPromise","$stateParams",function(e,t,n,o,s,r,i){n.group[i.id],o.gpost[i.id];e.group=r.data,console.log(r.data),e.currentUser=t.currentUser(),e.groups=n.groups,e.gposts=o.gposts,e.gcomments=s.gcomments,e.addGpost=function(){console.log(i.id),console.log(e.gpost),n.createGpost(e.gpost,i.id).success(function(t){e.group.gposts.push(t),e.gpost=null}),mixpanel.identify(e.user._id),mixpanel.track("Add Post",{area:"group",page:"groupHome",action:"create"})},e.addGcomment=function(e,t){console.log("in controller",e,t),e.gcomments.push(t),n.createGcomment(e._id,t),console.log(e._id,t)},e.isAdmin=t.isAdmin,e.isUser=t.isUser,e.isLoggedIn=t.isLoggedIn}]),app.controller("GpostCtrl",["$scope","$stateParams","gposts","gcomments","auth",function(e,t,n,o,s){var r=n.gpost[t.id];e.get(r._id),e.gpost=n.gpost,e.gcomments=o.gcomments,e.addGcomment=function(){scope.body&&""!==e.body&&(n.addGcomment(n.gpost._id,{body:e.body,author:"user"}).success(function(t){e.gpost.gcomments.push(t)}),e.body="")},e.incrementUpvotes=function(e){n.upvoteGroupComment(r,e)},e.isLoggedIn=s.isLoggedIn,e.isAdmin=s.isAdmin,e.isUser=s.isUser}]),app.factory("posts",["$http","auth",function(e,t){var n={posts:[],post:{}};return n.getAll=function(){return e.get("/api/posts").success(function(e){angular.copy(e,n.posts)})},n.create=function(o){return console.log(o),e.post("/api/posts",o,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){n.posts.push(e)})},n.upvote=function(n){return e.put("/api/post/"+n._id+"/upvote",null,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){n.upvotes+=1})},n.get=function(t){return e.get("/api/posts/"+t).then(function(e){return console.log(e),e})},n.addComment=function(n,o){return console.log(n,o),e.post("/api/post/"+n._id+"/comments",o,{headers:{Authorization:"Bearer "+t.getToken()}})},n.upvoteComment=function(n,o){return e.put("/api/post/"+n._id+"/comment/"+o._id+"/upvote",null,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){o.upvotes+=1})},n}]),app.factory("comments",["$http","auth",function(e,t){var n={comments:[]};return n.getAll=function(){return e.get("/api/comments").success(function(e){angular.copy(e,n.comments)})},n}]),app.factory("items",["$http","auth",function(e,t){function n(e){var t=e[e.type];for(var n in t)t.hasOwnProperty(n)&&t[n]!==t._id&&(e[n]=t[n],e[e.type]=t._id)}var o={items:[],item:{},videos:[],video:{},books:[],book:{}};return o.create=function(n){return e.post("/api/items",n,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){var t=angular.extend(e,n);return o.items.push(t),e})},o.getAll=function(){return e.get("/api/items").success(function(e){angular.forEach(e,function(e){e=n(e)}),angular.copy(e,o.items)})},o.get=function(t){return e.get("/api/item/"+t).success(function(e){return n(e)})},o["delete"]=function(t){return console.log(item),e["delete"]("/api/items/"+item._id,item).success(function(e){})},o.getAllVideos=function(){return e.get("/api/videos").success(function(e){angular.copy(e,o.videos)})},o.update=function(n){return e.put("/api/item/"+n.type+"/"+n[n.type],n,{headers:{Authorization:"Bearer "+t.getToken()}})},o.upvote=function(n){return e.put("/api/items/"+n._id+"/upvote",null,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){n.upvotes+=1})},o.addTransaction=function(t,n){return e.post("/api/items/"+t+"/transactions",n,{headers:{Authorization:"Bearer "+transactions.getToken()}}).success(function(e){transactions.push(e)})},o.newPlan=function(n,s){return e.post("/api/workoutPlans/"+s,n,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){var t=angular.extend(e,n);o.items.push(t)})},o.newStep=function(n,s){return e.post("/api/item/exercise/"+s,n,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){var t=angular.extend(e,n);o.items.push(t)})},o.getExercise=function(t){return console.log(t),e.get("/api/item/exercise/"+t).then(function(e){return e.data})},o.getExercises=function(t){return e.get("/api/items/"+t+"/exercises").success(function(e){console.log(e),angular.copy(e,o.items)})},o.getStep=function(t){return console.log(t),e.get("/api/item/step/"+t).then(function(e){return e.data})},o}]),app.factory("transactions",["$http","auth",function(e,t){var n={transactions:[]};return n.get=function(t){return e.get("/api/transactions/"+t).then(function(e){return e.data})},n.purchase=function(n){return console.log(n),e.post("/api/transactions",n,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){console.log(e)})},n}]),app.factory("customers",["$http","auth",function(e,t){var n={customers:[]};return n.get=function(t){return e.get("/api/customers/"+t).then(function(e){return e.data})},n}]),app.factory("auth",["$http","$window",function(e,t){var n={};return n.saveToken=function(e){t.localStorage["admin-token"]=e},n.getToken=function(){return t.localStorage["admin-token"]},n.isLoggedIn=function(){var e=n.getToken();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return o.exp>Date.now()/1e3}return!1},n.currentUser=function(){if(n.isLoggedIn()){var e=n.getToken(),o=JSON.parse(t.atob(e.split(".")[1]));return o.username}},n.isThisUser=function(){if(n.isLoggedIn()){var e=n.getToken(),o=JSON.parse(t.atob(e.split(".")[1]));return o._id}},n.isUser=function(){var e=n.getToken();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return"User"===o.permissions||"Admin"||"Contributor"}return!1},n.isContributor=function(){var e=n.getToken();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return"Admin"===o.permissions||"Contributor"}return!1},n.isAdmin=function(){var e=n.getToken();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return"Admin"===o.permissions}return!1},n.logOut=function(){t.localStorage.removeItem("admin-token"),t.location="http://localhost:3000"},n.getUser=function(){if(n.isLoggedIn()){var e=n.getToken(),o=JSON.parse(t.atob(e.split(".")[1]));return o}},n}]),app.factory("languages",["$http","$window",function(e,t){var n={languages:[]};return n.getAll=function(){return e.get("/api/languages").success(function(e){console.log(e),angular.copy(e,n.languages)})},n.addLanguage=function(t){return console.log(t),e.post("/api/user/:id/languages",{name:t}).success(function(e){console.log(e),n.languages.push(e)})},n}]),app.factory("settings",["$http","$window",function(e,t){var n={settings:{}};return n.getAll=function(){return e.get("/api/settings").success(function(e){angular.copy(e,n.settings)})},n.update=function(t){return console.log("updating user",t),e.put("/api/settings",t).success(function(e){n.settings=e})},n.uploadAvatar=function(e){},n.get=function(t){return e.get("/api/user/handle/"+t).success(function(e){return console.log(e),e})},n}]),app.factory("users",["$http","$window","auth",function(e,t,n){var o={users:[],user:{}};return o.getAll=function(){return e.get("/api/users").success(function(e){angular.copy(e,o.users)})},o.getRange=function(t,o){return e.get("/api/users/"+t+"/"+o,{headers:{Authorization:"Bearer "+n.getToken()}})},o.search=function(t){return e.get("/api/users/search/"+t).success(function(e){return e})},o.get=function(t){return e.get("/api/user/"+t).success(function(e){return console.log(e),e})},o.update=function(t){return console.log("updating user",t),e.put("/api/settings",t).success(function(e){o.users=e})},o.get=function(t){return e.get("/api/user/"+t).success(function(e){return o.user=e,e})},o.getAllButSelf=function(){var e=o.users;return angular.forEach(e,function(t,o){t.username===n.currentUser()&&e.splice(o,1)}),e},o}]),app.factory("groups",["$http","auth",function(e,t){var n={groups:[],group:{}};return n.getAll=function(){return e.get("/api/groups").success(function(e){console.log(e),angular.copy(e,n.groups)})},n.create=function(t){return console.log(t),e.post("/api/groups",t).success(function(e){console.log(e),n.groups.push(e)})},n.get=function(t){return e.get("/api/group/"+t).then(function(e){return console.log(e),e})},n.createGpost=function(n,o){return console.log(n,o),e.post("/api/group/"+o+"/gposts",n,{headers:{Authorization:"Bearer "+t.getToken()}})},n.createGcomment=function(n,o){return console.log("gpost_id in factory",n),console.log("gcomment in factory",o),e.post("/api/gpost/"+n+"/gcomments",o,{headers:{Authorization:"Bearer "+t.getToken()}})},n}]),app.factory("gposts",["$http","auth",function(e,t){var n={gposts:[],gpost:{}};return n.getAll=function(t){return e.get("/api/group/"+t+"/gposts").success(function(e){console.log(e),angular.copy(e,n.gposts)})},n}]),app.factory("gcomments",["$http","auth",function(e,t){var n={gcomments:[]};return n.getAll=function(){return e.get("/api/gcomments").success(function(e){angular.copy(e,n.gcomments)})},n}]),app.controller("MessengerCtrl",["$scope","settings","users","messenger","messageSocket","Conversation","Message",function(e,t,n,o,s,r,i){function a(t){t._id&&(e.newmessage.conversation=t._id,l(t),o.readMessages(t),e.mainConversation=t)}function u(){o.postMessage(e.mainConversation,e.newmessage).success(function(){e.newmessage.body=null})}function c(t){console.log("a new message for conversation "+t.convo_id);for(var n=0;n<e.conversations.length;n++)if(e.conversations[n]._id===t.convo_id){e.conversations[n].latest=t,e.mainConversation._id===e.conversations[n]._id&&l(e.mainConversation);break}}function l(e){o.get(e._id).success(function(t){e.messages=t})}e.debug=!0,e.users=n.getAllButSelf(),angular.extend(e.user,n.user),e.newmessage=new i(e.user),e.conversations=o.conversations||[],e.map=o.map||{},e.conversations.length>0&&a(e.conversations[0]),e.focusConversation=a,e.print=function(e){console.log(e)},e.initConversation=function(){e.mainConversation&&e.mainConversation["new"]||(e.addUserModal=!0,e.copyOfUsers=angular.copy(e.users,e.copyOfUsers),e.conversations.unshift(new r),a(e.conversations[0]),e.mainConversation.users.push(e.user))},e.cancelNewConversation=function(){e.conversations.splice(0,1),a(e.conversations[0])},e.searchUsers=function(){n.search(e.conversation.userQuery).success(function(t){e.conversation.userResult=t})},e.addToConversation=function(t){e.mainConversation.users.push(t),angular.forEach(e.copyOfUsers,function(n,o){n._id===t._id&&e.copyOfUsers.splice(o,1)})},e.sendMessage=function(){return e.mainConversation.users.length<2?void console.log("need a user to message with besides yourself!"):void(e.mainConversation._id?u():o.createConversation(e.mainConversation).success(function(t){e.mainConversation._id=t._id,e.addUserModal=!1,u()}))},e.$on("socket:newmessage",function(t,n){console.log("got a new message",t.name,n),n.payload&&e.$apply(function(){c(n.payload)})}),e.$on("socket:newconversation",function(t,n){console.log("get a new convo",t.name,n.payload),e.$apply(function(){o.getAll().success(function(t){e.conversations=t,n.payload.initiator===e.user._id&&a(n.payload.convo)})})}),e.$on("socket:readmessages",function(t,n){console.log("new read timestamps on convo",n),e.$apply(function(){n.payload._id===e.mainConversation._id&&l(e.mainConversation)})}),e.isSelf=function(t){return t===e.user._id},e.otherPeople=function(t){var n=angular.copy(t.users,n);return angular.forEach(n,function(t,o){e.isSelf(t._id)&&n.splice(o,1)}),angular.forEach(n,function(e,t){n[t]=e.f_name+" "+e.l_name}),n.join(", ")}}]),app.directive("conversationAddUsers",function(){return{restrict:"E",controller:"MessengerCtrl",scope:!1,template:'<div class="col-sm-12"><div ng-repeat="user in users | orderBy:\'username\'" ng-click="addToConversation(user)"><i class="fa fa-plus"></i> {{user.handle || user.username}} {{user.f_name + \' \' + user.l_name}}</div><div class="col-sm-12" ng-repeat="user in conversation.userResult"><div class="col-sm-1">Pic</div><div class="col-sm-10">{{user.handle}} | {{user.f_name}} {{user.l_name}}</div><div class="col-sm-1"> </div></div></div>',link:function(e,t,n){}}}),app.directive("messageBox",function(){return{restrict:"EA",controller:["$scope","$element",function(e,t){e.$watch("messageLog",function(){var e=t[0].children[0];e.scrollTop=e.scrollHeight})}]}}),app.directive("scrollBottom",function(){return{scope:{scrollBottom:"="},link:function(e,t){e.$watchCollection("scrollBottom",function(e){e&&$(t).scrollTop($(t)[0].scrollHeight)})}}}),app.factory("messenger",["$http","auth",function(e,t){var n={conversations:[],map:{}};return n.getAll=function(){return e.get("/api/conversations",{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){return angular.copy(e,n.conversations),angular.forEach(e,function(e){n.map[e._id]=e}),e})},n.get=function(t){return e.get("/api/conversation/"+t).success(function(e){return e})},n.createConversation=function(n){return e.post("/api/conversation",n,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){return console.log("create convo data",e),e})},n.postMessage=function(n,o){return e.post("/api/conversation/"+n._id+"/messages",o,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){return e})},n.readMessages=function(n){return e.put("/api/conversation/"+n._id+"/read",{user_id:t.getUser()._id},{headers:{Authorization:"Bearer "+t.getToken()}})},n}]),app.factory("Conversation",function(){var e=function(){var e=this;e.users=[],e.messages=[],e["new"]=!0};return e}),app.factory("Message",function(){var e=function(e){var t=this;t.user=e._id||null,t.f_name=e.f_name||null,t.l_name=e.l_name||null,t.handle=e.handle||null};return e}),app.factory("messageSocket",["socketFactory",function(e){var t=e();return t.forward("tokenrequest"),t.forward("broadcast"),t.forward("conversations"),t.forward("newmessage"),t.forward("newconversation"),t.forward("readmessages"),t}]),app.controller("DietCtrl",["$scope","$attrs","items","dietplans","Meal","Diet","Day","Recipe","CookingStep","Ingredient",function(e,t,n,o,s,r,i,a,u,c){function l(e){d=e.duration;for(var t,n=e.days.length;d>n;)t=new i,t.day.order=n+1,e.days.push(t),n++}var p=this;e.debug=!0;var g,m,d;this.init=function(t){p.$element=t,l(e.item),e.dayIndex=1,e.mealIndex=1,g=e.item.days[0],m=g.meals.length,console.log("_mealCount",m)},e.decrementDay=function(){e.dayIndex>1&&e.dayIndex--,g=e.item.days[e.dayIndex],m=g.meals.length},e.incrementDay=function(){e.dayIndex<e.item.days.length&&e.dayIndex++,g=e.item.days[e.dayIndex],m=g.meals.length},e.decrementMeal=function(){e.mealIndex>1&&e.mealIndex--},e.incrementMeal=function(){e.mealIndex<m+1&&e.mealIndex++},e.meal=null,e.recipe=null,e.step=null,e.ingredient=null,e.initMeal=function(){e.meal=new s},e.initRecipe=function(){e.recipe=new a},e.initStep=function(){e.step=new u,e.step.order=e.recipe.steps.length+1},e.initIngredient=function(){e.ingredient=new c},e.cancelMeal=function(){e.meal=null},e.cancelRecipe=function(){e.recipe=null},e.cancelStep=function(){e.step=null},e.cancelIngredient=function(){e.ingredient=null},e.saveDiet=function(){e.item._id?n.update(e.item):n.create(e.item).success(function(t){e.item=t,e.initMeal(),e.meal.day=1})},e.saveMeal=function(){e.item.day.push(e.meal),n.update(e.item),e.meal=new s},e.saveRecipe=function(){o.createRecipe(e.recipe),e.meal.recipes.push(e.recipe),e.recipe=null},e.saveStep=function(){e.recipe.steps.push(e.step),e.step=null},e.saveIngredient=function(){e.recipe.ingredients.push(e.ingredient),e.ingredient=null}}]),app.directive("dietPlan",function(){return{restrict:"E",scope:{item:"=item"},controller:"DietCtrl",templateUrl:"shop.dietplan.tpl.html",link:function(e,t,n,o){o.init(t)}}}),app.directive("mealRecipes",function(){return{restrict:"E",template:['<div ng-repeat="recipe in recipes">','<div class="col-sm-3><i class="fa fa-2x fa-photo"></i></div>','<div class="col-sm-9>{{recipe.title}} <br/>',"{{recipe.yield}} Servings</div>","</div>"].join(),link:function(){}}}),app.directive("mealRecipeAdder",function(){return{restrict:"E",template:["<div>",'<div ng-show="recipe"><small>upload</small> <i class="fa fa-lg fa-photo"></i>','<input type="text" placeholder="Recipe" ng-model="recipe.title" ng-blur="searchRecipes()">','<input type="text" placeholder="Servings" ng-model="recipe.yield">','<br/><a ng-click="initRecipe()">+ new recipe</a>',"</div>",'<div style="border: 1px solid #999" ng-click="initMeal()" ><i class="fa fa-2x fa-plus"></i></div>',"</div>"].join()}}),app.directive("recipeCreator",function(){return{restrict:"E",controller:"DietCtrl",templateUrl:"shop.recipe.tpl.html",link:function(e,t,n){}}}),app.directive("workoutPlan",function(){return{restrict:"E",scope:!1,templateUrl:"shop.workoutplan.tpl.html",link:function(e,t,n){}}}),app.directive("digitalMedia",function(){return{restrict:"E",scope:!1,templateUrl:"shop.digitalmedia.tpl.html",link:function(e,t,n){}}}),app.factory("Item",function(){var e=function(){this.name=null,this.creator={username:null,_id:null},this.price=null,this.upvotes=null,this.type=null};return e}),app.factory("Diet",function(){var e=function(){this.category=null,this.hashtag=null,this.description=null,this.duration=1,this.gender=null,this.age=null,this.meals=[]};return e}),app.factory("Day",function(){var e=function(){this.day={name:null,order:null},this.title=null,this.meals=[],this.exercises=[]};return e}),app.factory("Meal",function(){var e=function(){this.name=null,this.type=null,this.description=null,this.day=null,this.cooktime=null,this.preptime=null,this.recipes=[]};return e}),app.factory("Recipe",function(){var e=function(){this.name=null,this.type=null,this.description=null,this.video=null,this.coverphoto=null,this.photos=[],this["yield"]=null,this.cost=null,this.preptime=null,this.cooktime=null,this.equipment=null,this.steps=[],this.ingredients=[],this.calories=null,this.fats=null,this.carbs=null,this.proteins=null};return e}),app.factory("CookingStep",function(){var e=function(){this.order=null,this.description=null,this.photo=null};return e}),app.factory("Ingredient",function(){var e=function(){this.name=null,this.category=null,this.description=null,this.photo=null,this.value=null,this.unit=null,this.preparation=null};return e}),app.factory("dietplans",["$http","auth",function(e,t){var n={};return n.get=function(n){return e.get("/api/item/dietplan/"+n,{headers:{Authorization:"Bearer "+t.getToken()}})},n.update=function(n){return e.put("/api/item/dietplan/"+n.dietplan,n,{headers:{Authorization:"Bearer "+t.getToken()}})},n.createRecipe=function(n){return e.post("/api/item/dietplan/recipes",n,{headers:{Authorization:"Bearer "+t.getToken()}})},n.createIngredient=function(n){return e.post("/api/item/dietplan/ingredients",n,{headers:{Authorization:"Bearer "+t.getToken()}})},n}]),app.directive("tvAddWidget",function(){return{restrict:"E",scope:{parent:"=parent",items:"=children"},transclude:!0,controller:"addWidgetCtrl",template:["<div>","<ng-transclude></ng-transclude>","</div>"].join()}}),app.directive("tvAddWidgetItem",function(){return{restrict:"E",require:"tvAddWidget",transclude:!0,replace:!0,template:["<div>",'<div class="add-widget-photo"><i class="fa fa-3x fa-photo"></i></div>','<div class="add-widget-title">{{item.name}}</div>','<div class="add-widget-body"><ng-transclude></ng-transclude></div>',"</div>"].join()}}),app.controller("addWidgetCtrl",["$scope",function(e){e.initChild=function(){console.log("init child")}}]);
=======
var app=angular.module("mainApp",["ui.router","templates","btford.socket-io"]);app.config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("home",{url:"/home",templateUrl:"home.html",controller:"DashCtrl",resolve:{postsPromise:["posts",function(e){return e.getAll()}]}}).state("post",{url:"/post/:post",templateUrl:"post.html",controller:"PostCtrl",resolve:{postPromise:["$stateParams","posts",function(e,t){return t.get(e.post)}]}}).state("shop",{url:"/shop",templateUrl:"shop.html",controller:"ShopCtrl",resolve:{itemPromise:["items",function(e){return e.getAll()}]}}).state("events",{url:"/events",templateUrl:"events.html",controller:"ShopCtrl",resolve:{itemPromise:["$stateParams","items",function(e,t){return console.log(e),t.get(e.item)}]}}).state("item",{url:"/item/:id",templateUrl:"item.html",controller:"ItemCtrl",resolve:{itemPromise:["$stateParams","items",function(e,t){return t.get(e.id)}]}}).state("challenge",{url:"/items/challenge/:id",templateUrl:"challenge.html",controller:"ItemsCtrl",resolve:{itemPromise:["$stateParams","items",function(e,t){return console.log(e.id),t.get(e.id)}]}}).state("workoutPlan",{url:"/items/workoutplan/:id",templateUrl:"workoutPlan.html",controller:"ItemsCtrl",resolve:{itemPromise:["$stateParams","items",function(e,t){return console.log(e.id),t.get(e.id)}]}}).state("exerciseSteps",{url:"/items/exercise/:exercise",templateUrl:"exerciseSteps.html",controller:"ExerciseCtrl",resolve:{exercisePromise:["$stateParams","items",function(e,t){return console.log(e.exercise),t.getExercise(e.exercise)}]}}).state("stepConsumption",{url:"/items/step/:step",templateUrl:"stepConsumption.html",controller:"StepCtrl",resolve:{stepPromise:["$stateParams","items",function(e,t){return console.log(e.step),t.getStep(e.step)}]}}).state("transactions",{url:"/transactions/:item",templateUrl:"transactions.html",controller:"TransCtrl",resolve:{itemPromise:["$stateParams","items",function(e,t){return t.get(e.item)}]}}).state("checkout",{url:"/checkout",templateUrl:"checkout.html",controller:"CheckoutCtrl",resolve:{item:["$stateParams","items",function(e,t){return t.get(e.id)}]}}).state("groups",{url:"/groups",templateUrl:"groups.html",controller:"GroupsCtrl",resolve:{groupPromise:["groups",function(e){return e.getAll()}]}}).state("groupHome",{url:"/group/:id",templateUrl:"group_home.html",controller:"GHomeCtrl",resolve:{groupsPromise:["$stateParams","groups",function(e,t){return t.get(e.id)}]}}).state("messenger",{url:"/messenger",templateUrl:"messenger.html",controller:"MessengerCtrl",resolve:{usersPromise:["users",function(e){return e.getAll()}],conversationsPromise:["messenger",function(e){return e.getAll()}]}}).state("settings",{url:"/settings/:id",templateUrl:"settings.html",controller:"SettingsCtrl",resolve:{languagePromise:["languages",function(e){return e.getAll()}],userPromise:["$stateParams","users",function(e,t){return t.get(e.id)}]}}).state("user",{url:"/user/:handle",templateUrl:"users.html",controller:"UserCtrl",resolve:{userPromise:["$stateParams","users",function(e,t){return t.get(e.id)}]}}),t.otherwise("home")}]),app.controller("MainCtrl",["$scope","auth","messageSocket",function(e,t,n){e.user=t.getUser(),mixpanel.alias(e.user._id),mixpanel.identify(e.user._id),mixpanel.people.set({$email:e.user.username,$last_login:new Date}),e.isLoggedIn=t.isLoggedIn,e.isUser=t.isUser,e.isContributor=t.isContributor,e.isAdmin=t.isAdmin,e.logOut=t.logOut,e.isThisUser=t.isThisUser,e.$on("socket:tokenrequest",function(e,o){console.log("socket:tokenrequest",e.name,o),console.log(o.message),n.emit("authenticate",{token:t.getToken()})}),e.$on("socket:broadcast",function(e,t){console.log("broadcast to socket",e.name,t)})}]),app.controller("DashCtrl",["$scope","posts","auth",function(e,t,n){e.posts=t.posts,e.addPost=function(){e.title&&""!==e.title&&(t.create({title:e.title,link:e.link}),e.title="",e.link="",mixpanel.identify(e.user._id),mixpanel.track("Add Post",{area:"group",page:"groupHome",action:"create"}))},e.incrementUpvotes=function(n){t.upvote(n),mixpanel.identify(e.user._id),mixpanel.track("Upvote Post",{area:"group",page:"groupHome",action:"upvote"})},e.isLoggedIn=n.isLoggedIn,e.isAdmin=n.isAdmin,e.isUser=n.isUser}]),app.controller("PostCtrl",["$scope","auth","posts","postPromise",function(e,t,n,o){e.post=o.data,e.comment={post:e.post._id,body:null,author:e.user.username},e.addComment=function(){e.comment.body&&""!==e.comment.body&&(n.addComment(e.post,e.comment).success(function(t){e.post.comments.push(t),e.comment.body=null}),e.body="",mixpanel.identify(e.user._id),mixpanel.track("Add Comment",{area:"group",page:"groupHome",action:"comment"}))},e.incrementUpvotes=function(t){n.upvoteComment(post,t),mixpanel.identify(e.user._id),mixpanel.track("Upvote Comment",{area:"group",page:"groupHome",action:"upvote"})},e.incrementUpvotes=function(t){n.upvoteComment(e.post,t)},e.isLoggedIn=t.isLoggedIn,e.isAdmin=t.isAdmin,e.isUser=t.isUser}]),app.controller("ShopCtrl",["$scope","items","Item","auth",function(e,t,n,o){e.items=t.items,e.addItem=function(){t.create(e.item).success(function(o){console.log("success"),e.items=t.items,e.item=new n,console.log(o)}).error(function(){console.log("failure")}),mixpanel.identify(e.user._id),mixpanel.track("Add Item",{area:"shop",page:"shop",action:"create"})},e.itemTitles={workoutplan:"Workout Plan",dietplan:"Diet Plan",book:"Book",video:"Video",podcast:"Podcast",bootcamp:"Bootcamp",challenge:"Online Challenge"},e.incrementUpvotes=function(n){t.upvoteItem(n),mixpanel.identify(e.user._id),mixpanel.track("Upvote Item",{area:"shop",page:"shop",action:"upvote"})},e.editItem=function(t){e.item=t},e.isAdmin=o.isAdmin,e.isUser=o.isUser}]),app.controller("ItemCtrl",["$scope","$state","$stateParams","items","auth","Item","itemPromise","popupService",function(e,t,n,o,s,i,r,a){e.items=o.items,e.item=r.data,item=r,e.deleteItem=function(){console.log("delete",e.item._id),a.showPopup("Are you sure you want to delete this item?")&&o["delete"](e.item._id).success(function(n){console.log(n.message),e.items=o.items,t.go("shop")})},e.createDay=function(){o.newDay(n.id,e.day.day).success(function(t){e.item.days.push(t)})},e.incrementUpvotes=function(t){o.upvoteItem(t),mixpanel.identify(e.user._id),mixpanel.track("Upvote Item",{area:"shop",page:"shop",action:"upvote"})},e.isAdmin=s.isAdmin,e.isUser=s.isUser,e.addPlan=function(){o.newPlan(e.workoutPlan,n.id).success(function(t){console.log("success"),e.item.exercises.push(t)}).error(function(){console.log("failure")})}}]),app.controller("ExerciseCtrl",["$scope","items","exercisePromise","$stateParams",function(e,t,n,o){e.exercise=n,e.addStep=function(){t.newStep(e.step,o.exercise).success(function(t){console.log("success"),e.step=null,e.exercise.steps.push(t)}).error(function(){console.log("failure")})}}]),app.controller("StepCtrl",["$scope","items","stepPromise","$stateParams",function(e,t,n,o){e.step=n}]),app.controller("NavCtrl",["$scope","auth",function(e,t){e.isLoggedIn=t.isLoggedIn,e.home=t.isLoggedIn,e.currentUser=t.currentUser,e.logOut=t.logOut}]),app.controller("TransCtrl",["$scope","items","auth","transactions","itemPromise",function(e,t,n,o,s){e.item=s.data,e.startTrans=function(){console.log(e.item),o.purchase(e.item),mixpanel.identify(e.user._id),mixpanel.track("Start Transaction",{area:"shop",page:"transactions",action:"transaction"})},e.isAdmin=n.isAdmin,e.isUser=n.isUser}]),app.controller("SettingsCtrl",["$scope","languages","settings","userPromise","auth",function(e,t,n,o,s){e.user=angular.extend(e.user,n.settings),e.languages=t.languages,e.addLanguage=function(){console.log(e.language.name),t.addLanguage(e.language.name).success(function(t){e.languages.push(t)}),mixpanel.identify(e.user._id),mixpanel.track("Add Languange",{area:"settings",page:"settings",action:"add"})},e.updateSettings=function(){console.log(e.user),n.update(e.user),mixpanel.identify(e.user._id),mixpanel.track("Settings update",{area:"settings",page:"settings",action:"update"})},e.user=o.data,console.log(o),e.isAdmin=s.isAdmin,e.isUser=s.isUser,e.isThisUser=s.isThisUser}]),app.controller("GroupsCtrl",["$scope","groups","auth",function(e,t,n){e.groups=t.groups,e.addGroup=function(){t.create(e.group),console.log(e.group),mixpanel.identify(e.user._id),mixpanel.track("Add Group",{area:"group",page:"groups",action:"create"})},e.group="",e.isLoggedIn=n.isLoggedIn,e.isAdmin=n.isAdmin,e.isUser=n.isUser}]),app.controller("GHomeCtrl",["$scope","auth","groups","gposts","gcomments","groupsPromise","$stateParams",function(e,t,n,o,s,i,r){n.group[r.id],o.gpost[r.id];e.group=i.data,console.log(i.data),e.currentUser=t.currentUser(),e.groups=n.groups,e.gposts=o.gposts,e.gcomments=s.gcomments,e.addGpost=function(){console.log(r.id),console.log(e.gpost),n.createGpost(e.gpost,r.id).success(function(t){e.group.gposts.push(t),e.gpost=null}),mixpanel.identify(e.user._id),mixpanel.track("Add Post",{area:"group",page:"groupHome",action:"create"})},e.addGcomment=function(e,t){console.log("in controller",e,t),e.gcomments.push(t),n.createGcomment(e._id,t),console.log(e._id,t)},e.isAdmin=t.isAdmin,e.isUser=t.isUser,e.isLoggedIn=t.isLoggedIn}]),app.controller("GpostCtrl",["$scope","$stateParams","gposts","gcomments","auth",function(e,t,n,o,s){var i=n.gpost[t.id];e.get(i._id),e.gpost=n.gpost,e.gcomments=o.gcomments,e.addGcomment=function(){scope.body&&""!==e.body&&(n.addGcomment(n.gpost._id,{body:e.body,author:"user"}).success(function(t){e.gpost.gcomments.push(t)}),e.body="")},e.incrementUpvotes=function(e){n.upvoteGroupComment(i,e)},e.isLoggedIn=s.isLoggedIn,e.isAdmin=s.isAdmin,e.isUser=s.isUser}]),app.factory("posts",["$http","auth",function(e,t){var n={posts:[],post:{}};return n.getAll=function(){return e.get("/api/posts").success(function(e){angular.copy(e,n.posts)})},n.create=function(o){return console.log(o),e.post("/api/posts",o,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){n.posts.push(e)})},n.upvote=function(n){return e.put("/api/post/"+n._id+"/upvote",null,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){n.upvotes+=1})},n.get=function(t){return e.get("/api/posts/"+t).then(function(e){return console.log(e),e})},n.addComment=function(n,o){return console.log(n,o),e.post("/api/post/"+n._id+"/comments",o,{headers:{Authorization:"Bearer "+t.getToken()}})},n.upvoteComment=function(n,o){return e.put("/api/post/"+n._id+"/comment/"+o._id+"/upvote",null,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){o.upvotes+=1})},n}]),app.factory("comments",["$http","auth",function(e,t){var n={comments:[]};return n.getAll=function(){return e.get("/api/comments").success(function(e){angular.copy(e,n.comments)})},n}]),app.factory("items",["$http","auth",function(e,t){function n(e){var t=e[e.type];for(var n in t)t.hasOwnProperty(n)&&t[n]!==t._id&&(e[n]=t[n],e[e.type]=t._id)}var o={items:[],item:{},videos:[],video:{},books:[],book:{}};return o.create=function(n){return e.post("/api/items",n,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){var t=angular.extend(e,n);return o.items.push(t),e})},o.getAll=function(){return e.get("/api/items").success(function(e){angular.forEach(e,function(e){e=n(e)}),angular.copy(e,o.items)})},o.get=function(t){return e.get("/api/item/"+t).success(function(e){return n(e)})},o["delete"]=function(n){return e["delete"]("/api/item/"+n,{headers:{Authorization:"Bearer "+t.getToken()}})},o.getAllVideos=function(){return e.get("/api/videos").success(function(e){angular.copy(e,o.videos)})},o.update=function(n){return e.put("/api/item/"+n._id,n,{headers:{Authorization:"Bearer "+t.getToken()}})},o.upvote=function(n){return e.put("/api/items/"+n._id+"/upvote",null,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){n.upvotes+=1})},o.addTransaction=function(t,n){return e.post("/api/items/"+t+"/transactions",n,{headers:{Authorization:"Bearer "+transactions.getToken()}}).success(function(e){transactions.push(e)})},o.newPlan=function(n,s){return e.post("/api/workoutPlans/"+s,n,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){var t=angular.extend(e,n);o.items.push(t)})},o.newStep=function(n,s){return e.post("/api/item/exercise/"+s,n,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){var t=angular.extend(e,n);o.items.push(t)})},o.getExercise=function(t){return console.log(t),e.get("/api/item/exercise/"+t).then(function(e){return e.data})},o.getExercises=function(t){return e.get("/api/items/"+t+"/exercises").success(function(e){console.log(e),angular.copy(e,o.items)})},o.getStep=function(t){return console.log(t),e.get("/api/item/step/"+t).then(function(e){return e.data})},o.updateDietplan=function(n,o){var s=n.dietplan,i=n.days_set,r="/api/item/dietplan/"+s+"/";return o.order?i<o.order?(o.days_set=i,e.post(r+"days",o,{headers:{Authorization:"Bearer "+t.getToken()}})):e.put(r+"days",o,{headers:{Authorization:"Bearer "+t.getToken()}}):void 0},o}]),app.factory("transactions",["$http","auth",function(e,t){var n={transactions:[]};return n.get=function(t){return e.get("/api/transactions/"+t).then(function(e){return e.data})},n.purchase=function(n){return console.log(n),e.post("/api/transactions",n,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){console.log(e)})},n}]),app.factory("customers",["$http","auth",function(e,t){var n={customers:[]};return n.get=function(t){return e.get("/api/customers/"+t).then(function(e){return e.data})},n}]),app.factory("auth",["$http","$window",function(e,t){var n={};return n.saveToken=function(e){t.localStorage["admin-token"]=e},n.getToken=function(){return t.localStorage["admin-token"]},n.isLoggedIn=function(){var e=n.getToken();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return o.exp>Date.now()/1e3}return!1},n.currentUser=function(){if(n.isLoggedIn()){var e=n.getToken(),o=JSON.parse(t.atob(e.split(".")[1]));return o.username}},n.isThisUser=function(){if(n.isLoggedIn()){var e=n.getToken(),o=JSON.parse(t.atob(e.split(".")[1]));return o._id}},n.isUser=function(){var e=n.getToken();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return"User"===o.permissions||"Admin"||"Contributor"}return!1},n.isContributor=function(){var e=n.getToken();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return"Admin"===o.permissions||"Contributor"}return!1},n.isAdmin=function(){var e=n.getToken();if(e){var o=JSON.parse(t.atob(e.split(".")[1]));return"Admin"===o.permissions}return!1},n.logOut=function(){t.localStorage.removeItem("admin-token"),t.location="http://localhost:3000"},n.getUser=function(){if(n.isLoggedIn()){var e=n.getToken(),o=JSON.parse(t.atob(e.split(".")[1]));return o}},n}]),app.factory("languages",["$http","$window",function(e,t){var n={languages:[]};return n.getAll=function(){return e.get("/api/languages").success(function(e){console.log(e),angular.copy(e,n.languages)})},n.addLanguage=function(t){return console.log(t),e.post("/api/user/:id/languages",{name:t}).success(function(e){console.log(e),n.languages.push(e)})},n}]),app.factory("settings",["$http","$window",function(e,t){var n={settings:{}};return n.getAll=function(){return e.get("/api/settings").success(function(e){angular.copy(e,n.settings)})},n.update=function(t){return console.log("updating user",t),e.put("/api/settings",t).success(function(e){n.settings=e})},n.uploadAvatar=function(e){},n.get=function(t){return e.get("/api/user/handle/"+t).success(function(e){return console.log(e),e})},n}]),app.factory("users",["$http","$window","auth",function(e,t,n){var o={users:[],user:{}};return o.getAll=function(){return e.get("/api/users").success(function(e){angular.copy(e,o.users)})},o.getRange=function(t,o){return e.get("/api/users/"+t+"/"+o,{headers:{Authorization:"Bearer "+n.getToken()}})},o.search=function(t){return e.get("/api/users/search/"+t).success(function(e){return e})},o.get=function(t){return e.get("/api/user/"+t).success(function(e){return console.log(e),e})},o.update=function(t){return console.log("updating user",t),e.put("/api/settings",t).success(function(e){o.users=e})},o.get=function(t){return e.get("/api/user/"+t).success(function(e){return o.user=e,e})},o.getAllButSelf=function(){var e=o.users;return angular.forEach(e,function(t,o){t.username===n.currentUser()&&e.splice(o,1)}),e},o}]),app.factory("groups",["$http","auth",function(e,t){var n={groups:[],group:{}};return n.getAll=function(){return e.get("/api/groups").success(function(e){console.log(e),angular.copy(e,n.groups)})},n.create=function(t){return console.log(t),e.post("/api/groups",t).success(function(e){console.log(e),n.groups.push(e)})},n.get=function(t){return e.get("/api/group/"+t).then(function(e){return console.log(e),e})},n.createGpost=function(n,o){return console.log(n,o),e.post("/api/group/"+o+"/gposts",n,{headers:{Authorization:"Bearer "+t.getToken()}})},n.createGcomment=function(n,o){return console.log("gpost_id in factory",n),console.log("gcomment in factory",o),e.post("/api/gpost/"+n+"/gcomments",o,{headers:{Authorization:"Bearer "+t.getToken()}})},n}]),app.factory("gposts",["$http","auth",function(e,t){var n={gposts:[],gpost:{}};return n.getAll=function(t){return e.get("/api/group/"+t+"/gposts").success(function(e){console.log(e),angular.copy(e,n.gposts)})},n}]),app.factory("gcomments",["$http","auth",function(e,t){var n={gcomments:[]};return n.getAll=function(){return e.get("/api/gcomments").success(function(e){angular.copy(e,n.gcomments)})},n}]),app.service("popupService",["$window",function(e){this.showPopup=function(t){return e.confirm(t)}}]),app.controller("MessengerCtrl",["$scope","settings","users","messenger","messageSocket","Conversation","Message",function(e,t,n,o,s,i,r){function a(t){t._id&&(e.newmessage.conversation=t._id,l(t),o.readMessages(t),e.mainConversation=t)}function c(){o.postMessage(e.mainConversation,e.newmessage).success(function(){e.newmessage.body=null})}function u(t){console.log("a new message for conversation "+t.convo_id);for(var n=0;n<e.conversations.length;n++)if(e.conversations[n]._id===t.convo_id){e.conversations[n].latest=t,e.mainConversation._id===e.conversations[n]._id&&l(e.mainConversation);break}}function l(e){o.get(e._id).success(function(t){e.messages=t})}e.debug=!0,e.users=n.getAllButSelf(),angular.extend(e.user,n.user),e.newmessage=new r(e.user),e.conversations=o.conversations||[],e.map=o.map||{},e.conversations.length>0&&a(e.conversations[0]),e.focusConversation=a,e.print=function(e){console.log(e)},e.initConversation=function(){e.mainConversation&&e.mainConversation["new"]||(e.addUserModal=!0,e.copyOfUsers=angular.copy(e.users,e.copyOfUsers),e.conversations.unshift(new i),a(e.conversations[0]),e.mainConversation.users.push(e.user))},e.cancelNewConversation=function(){e.conversations.splice(0,1),a(e.conversations[0])},e.searchUsers=function(){n.search(e.conversation.userQuery).success(function(t){e.conversation.userResult=t})},e.addToConversation=function(t){e.mainConversation.users.push(t),angular.forEach(e.copyOfUsers,function(n,o){n._id===t._id&&e.copyOfUsers.splice(o,1)})},e.sendMessage=function(){return e.mainConversation.users.length<2?void console.log("need a user to message with besides yourself!"):void(e.mainConversation._id?c():o.createConversation(e.mainConversation).success(function(t){e.mainConversation._id=t._id,e.addUserModal=!1,c()}))},e.$on("socket:newmessage",function(t,n){console.log("got a new message",t.name,n),n.payload&&e.$apply(function(){u(n.payload)})}),e.$on("socket:newconversation",function(t,n){console.log("get a new convo",t.name,n.payload),e.$apply(function(){o.getAll().success(function(t){e.conversations=t,n.payload.initiator===e.user._id&&a(n.payload.convo)})})}),e.$on("socket:readmessages",function(t,n){console.log("new read timestamps on convo",n),e.$apply(function(){n.payload._id===e.mainConversation._id&&l(e.mainConversation)})}),e.isSelf=function(t){return t===e.user._id},e.otherPeople=function(t){var n=angular.copy(t.users,n);return angular.forEach(n,function(t,o){e.isSelf(t._id)&&n.splice(o,1)}),angular.forEach(n,function(e,t){n[t]=e.f_name+" "+e.l_name}),n.join(", ")}}]),app.directive("conversationAddUsers",function(){return{restrict:"E",controller:"MessengerCtrl",scope:!1,template:'<div class="col-sm-12"><div ng-repeat="user in users | orderBy:\'username\'" ng-click="addToConversation(user)"><i class="fa fa-plus"></i> {{user.handle || user.username}} {{user.f_name + \' \' + user.l_name}}</div><div class="col-sm-12" ng-repeat="user in conversation.userResult"><div class="col-sm-1">Pic</div><div class="col-sm-10">{{user.handle}} | {{user.f_name}} {{user.l_name}}</div><div class="col-sm-1"> </div></div></div>',link:function(e,t,n){}}}),app.directive("messageBox",function(){return{restrict:"EA",controller:["$scope","$element",function(e,t){e.$watch("messageLog",function(){var e=t[0].children[0];e.scrollTop=e.scrollHeight})}]}}),app.directive("scrollBottom",function(){return{scope:{scrollBottom:"="},link:function(e,t){e.$watchCollection("scrollBottom",function(e){e&&$(t).scrollTop($(t)[0].scrollHeight)})}}}),app.factory("messenger",["$http","auth",function(e,t){var n={conversations:[],map:{}};return n.getAll=function(){return e.get("/api/conversations",{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){return angular.copy(e,n.conversations),angular.forEach(e,function(e){n.map[e._id]=e}),e})},n.get=function(t){return e.get("/api/conversation/"+t).success(function(e){return e})},n.createConversation=function(n){return e.post("/api/conversation",n,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){return console.log("create convo data",e),e})},n.postMessage=function(n,o){return e.post("/api/conversation/"+n._id+"/messages",o,{headers:{Authorization:"Bearer "+t.getToken()}}).success(function(e){return e})},n.readMessages=function(n){return e.put("/api/conversation/"+n._id+"/read",{user_id:t.getUser()._id},{headers:{Authorization:"Bearer "+t.getToken()}})},n}]),app.factory("Conversation",function(){var e=function(){var e=this;e.users=[],e.messages=[],e["new"]=!0};return e}),app.factory("Message",function(){var e=function(e){var t=this;t.user=e._id||null,t.f_name=e.f_name||null,t.l_name=e.l_name||null,t.handle=e.handle||null};return e}),app.factory("messageSocket",["socketFactory",function(e){var t=e();return t.forward("tokenrequest"),t.forward("broadcast"),t.forward("conversations"),t.forward("newmessage"),t.forward("newconversation"),t.forward("readmessages"),t}]),app.factory("Item",function(){var e=function(){this.name=null,this.creator={username:null,_id:null},this.price=null,this.upvotes=null,this.type=null};return e}),app.controller("DietCtrl",["$scope","$attrs","items","dietplans","Meal","Diet","Day","Recipe","CookingStep","Ingredient",function(e,t,n,o,s,i,r,a,c,u){var l=this;e.debug=!0,this.init=function(t){l.$element=t,0===e.item.days.length&&e.item.days.push(new r),angular.forEach(e.item.days,function(e){e.mealOrder=1}),e.dayOrder=1},e.decrementDay=function(){e.dayOrder>1&&e.dayOrder--},e.incrementDay=function(){e.dayOrder<e.item.duration?e.dayOrder++:alert("going over days, increase duration confirmation?")},e.decrementMeal=function(e){e.mealOrder>1&&e.mealOrder--},e.incrementMeal=function(e){e.mealOrder<e.meals.length&&e.mealOrder++},e.meal=null,e.recipe=null,e.step=null,e.ingredient=null,e.initMeal=function(){e.meal=new s,e.item.day[e.dayOrder-1].meals.push(e.meal)},e.initRecipe=function(){e.recipe=new a;var t=e.item.days[e.dayOrder-1];t.meals[t.mealOrder-1].recipes.push(e.recipe),e.addWidgetOptions.recipe.item=e.recipe},e.initStep=function(){e.step=new c,e.step.order=e.recipe.steps.length+1,e.addWidgetOptions.cookingstep.item=e.step},e.initIngredient=function(){e.ingredient=new u,e.addWidgetOptions.ingredient.item=e.step},e.cancelMeal=function(){e.meal=null},e.cancelRecipe=function(){e.recipe=null},e.cancelStep=function(){e.step=null},e.cancelIngredient=function(){e.ingredient=null},e.saveDiet=function(){e.item._id?n.update(e.item):n.create(e.item).success(function(t){e.item=t,e.initMeal(),e.meal.day=1})},e.saveMeal=function(){n.updateDietplan(e.item,e.item.days[e.dayOrder-1]).success(function(t){console.log(t),e.item.days_set=t.days_set,e.item.days=t.days})},e.saveRecipe=function(){o.createRecipe(e.recipe),e.meal.recipes.push(e.recipe),e.recipe=null},e.saveStep=function(){e.recipe.steps.push(e.step),e.step=null},e.saveIngredient=function(){e.recipe.ingredients.push(e.ingredient),e.ingredient=null},e.addWidgetOptions={ingredient:{name:"Ingredient",type:"ingredient",searchable:!0,fields:[{field:"amount","class":"col-sm-6"},{field:"preparation","class":"col-sm-6"},{field:"note","class":"col-sm-12"}],item:e.ingredient},recipe:{name:"Recipe",type:"recipe",searchable:!1,save:e.saveMeal,init:e.initRecipe,fields:[{field:"recipe","class":"col-sm-6"},{field:"servings","class":"col-sm-6"}],item:null},step:{show_name:!1,type:"cookingstep",searchable:!1,fields:[{field:"description","class":"col-sm-12"}],item:e.step}}}]),app.directive("dietPlan",function(){return{restrict:"E",scope:{item:"=item"},controller:"DietCtrl",templateUrl:"dietplan.tpl.html",link:function(e,t,n,o){o.init(t)}}}),app.directive("mealItinerary",function(){return{restrict:"E",controller:"DietCtrl",templateUrl:"mealitinerary.tpl.html",link:function(e,t,n){}}}),app.directive("recipeCreator",function(){return{restrict:"E",controller:"DietCtrl",templateUrl:"recipecreator.tpl.html",link:function(e,t,n){}}}),app.factory("Diet",function(){var e=function(){this.category=null,this.hashtag=null,this.description=null,this.duration=1,this.gender=null,this.age=null,this.meals=[]};return e}),app.factory("Day",function(){var e=function(e){this._id=null,this.order=e||1,this.title=null,this.meals=[],this.exercises=[],this.mealOrder=1};return e}),app.factory("Meal",function(){var e=function(){this.name=null,this.type=null,this.description=null,this.cost=null,this.cooktime=null,this.preptime=null,this.recipes=[]};return e}),app.factory("Recipe",function(){var e=function(){this.name=null,this.type=null,this.description=null,this.video=null,this.coverphoto=null,this.photos=[],this["yield"]=null,this.cost=null,this.preptime=null,this.cooktime=null,this.equipment=null,this.steps=[],this.ingredients=[],this.calories=null,this.fats=null,this.carbs=null,this.proteins=null};return e}),app.factory("CookingStep",function(){var e=function(){this.order=null,this.description=null,this.photo=null};return e}),app.factory("Ingredient",function(){var e=function(){this.name=null,this.category=null,this.description=null,this.photo=null,this.value=null,this.unit=null,this.preparation=null};return e}),app.factory("dietplans",["$http","auth",function(e,t){var n={};return n.get=function(n){return e.get("/api/item/dietplan/"+n,{headers:{Authorization:"Bearer "+t.getToken()}})},n.update=function(n){return e.put("/api/item/dietplan/"+n.dietplan,n,{headers:{Authorization:"Bearer "+t.getToken()}})},n.createRecipe=function(n){return e.post("/api/item/dietplan/recipes",n,{headers:{Authorization:"Bearer "+t.getToken()}})},n.createIngredient=function(n){return e.post("/api/item/dietplan/ingredients",n,{headers:{Authorization:"Bearer "+t.getToken()}})},n}]),app.directive("digitalMedia",function(){return{restrict:"E",scope:!1,templateUrl:"digitalmedia.tpl.html",link:function(e,t,n){}}}),app.directive("workoutPlan",function(){return{restrict:"E",scope:!1,templateUrl:"workoutplan.tpl.html",link:function(e,t,n){}}}),app.directive("addWidget",function(){return{restrict:"E",scope:{set:"=",options:"="},transclude:!0,controller:"addWidgetCtrl",template:'<div class="col-sm-12"><div>{{options}}</div></div>',link:function(e,t,n,o,s){s(e,function(e){console.log(e),element.append(e)})}}}),app.directive("addWidgetItems",function(){var e='<div ng-repeat="item in set"><div class="add-widget-photo"><i class="fa fa-3x fa-photo"></i></div><div class="add-widget-title">{{item.name}}</div><div class="add-widget-body" ng-transclude></div></div>';return{restrict:"E",require:"^addWidget",transclude:!0,template:e}}),app.directive("addWidgetForm",function(){var e='<div style="border: 1px solid #999" title="New {{item_type}}"><div class="col-sm-2"><i class="fa fa-2x fa-photo"></i></div><div class="col-sm-10"><span ng-transclude></span><input class="col-sm-{{options.searchable? \'8\' : \'12\'}}" type="text" placeholder="options.name" ng-model="item.name" ng-show="!!options.name"><button class="btn-sm col-sm-4" ng-click="search()" ng-if="options.search"><i class="fa fa-search"></i></button><input ng-class="field.class" type="text" ng-repeat="field in options.fields" placeholder="{{field.field}}" ng-model="item[field.field]"><button class="form-control btn-xs" ng-click="save()"><i class="fa fa-floppy-o"></i></button></div></div>';return{restrict:"E",require:"^addWidget",transclude:!0,replace:!0,template:e,link:function(e,t,n,o){}}}),app.directive("addWidgetPlus",function(){var e='<div class="text-center" style="height: 50px; border: 1px solid #999" title="Add {{item_type}}"><i class="fa fa-2x fa-plus"></i> {{item_type}}</div>';return{restrict:"E",require:"^addWidget",template:e,replace:!0,link:function(e,t,n,o){t.bind("click",function(){e.$apply(e.$parent.options.init()),console.log("clicked")})}}}),app.controller("addWidgetCtrl",["$scope",function(e){e.initChild=function(){console.log("init child")}}]),app.directive("slideDisplay",function(){return{restrict:"E",scope:{data:"=",options:"="},transclude:!0,controller:"slideCtrl",template:'<div class="col-sm-12" ng-transclude></div>'}});
>>>>>>> 4b19e9ffc62015d103f1b0121776cfbb0d86611b
