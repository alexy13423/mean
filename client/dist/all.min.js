var app=angular.module("mainApp",["templates"]);app.controller("MainCtrl",["$scope","auth",function(e,o){e.user={},e.register=function(){o.register(e.user).error(function(o){e.error=o}).then(function(){window.location="/user/#/home"})},e.logIn=function(){o.logIn(e.login).error(function(o){e.error=o}).then(function(){window.location="/user/#/home"})},e.forgotPassword=function(){o.forgotPassword(e.forgot).success(function(o){e.forgot={},e.success=!0,console.log(o.message)}).error(function(o){e.error=o}),mixpanel.track("User Reset Password",{area:"home",page:"home",action:"resetPassword"})},e.checkLoginState=function(){o.facebook(user._id),FB.getLoginStatus(function(e){statusChangeCallback(e)})},e.isLoggedIn=o.isLoggedIn,e.currentUser=o.currentUser,e.logOut=o.logOut}]),app.factory("auth",["$http","$window",function(e,o){var n={};return n.saveToken=function(e){o.localStorage["admin-token"]=e},n.getToken=function(){return o.localStorage["admin-token"]},n.isLoggedIn=function(){var e=n.getToken();if(e){var t=JSON.parse(o.atob(e.split(".")[1]));return t.exp>Date.now()/1e3}return!1},n.currentUser=function(){if(n.isLoggedIn()){var e=n.getToken(),t=JSON.parse(o.atob(e.split(".")[1]));return t.username}},n.register=function(o){return e.post("/api/register",o).success(function(e){n.saveToken(e.token)})},n.logIn=function(o){return e.post("/api/login",o).success(function(e){n.saveToken(e.token)})},n.logOut=function(){o.localStorage.removeItem("admin-token")},n.forgotPassword=function(o){return e.post("/api/forgot",o)},n.facebook=function(){var e=$q.defer();return FB.api("/me",{fields:"last_name"},function(o){!o||o.error?e.reject("Error occured"):e.resolve(o)}),e.promise},n.statusChangeCallback=function(e){console.log("statusChangeCallback"),console.log(e),"connected"===e.status?testAPI():document.getElementById("status").innerHTML="not_authorized"===e.status?"Please log into this app.":"Please log into Facebook."},n}]),app.factory("facebookService",["$q",function(e){facebookServce.getMyLastName=function(){var o=e.defer();return FB.api("/me",{fields:"last_name"},function(e){!e||e.error?o.reject("Error occured"):o.resolve(e)}),o.promise}}]);