var app=angular.module("mainApp",["templates"]);app.controller("MainCtrl",["$scope","auth",function(o,e){o.user={},o.register=function(){e.register(o.user).error(function(e){o.error=e}).then(function(){window.location="/user/#/home"})},o.logIn=function(){e.logIn(o.login).error(function(e){o.error=e}).then(function(){window.location="/user/#/home"})},o.forgotPassword=function(){e.forgotPassword(o.forgot).success(function(e){o.forgot={},o.success=!0,console.log(e.message)}).error(function(e){o.error=e}),mixpanel.track("User Reset Password",{area:"home",page:"home",action:"resetPassword"})},o.checkLoginState=function(){e.facebook(user._id),FB.getLoginStatus(function(o){statusChangeCallback(o)})},o.isLoggedIn=e.isLoggedIn,o.currentUser=e.currentUser,o.logOut=e.logOut}]),app.factory("auth",["$http","$window",function(o,e){var n={};return n.saveToken=function(o){e.localStorage["admin-token"]=o},n.getToken=function(){return e.localStorage["admin-token"]},n.isLoggedIn=function(){var o=n.getToken();if(o){var t=JSON.parse(e.atob(o.split(".")[1]));return t.exp>Date.now()/1e3}return!1},n.currentUser=function(){if(n.isLoggedIn()){var o=n.getToken(),t=JSON.parse(e.atob(o.split(".")[1]));return t.username}},n.isAdmin=function(){var o=n.getToken();if(o){var t=JSON.parse(e.atob(o.split(".")[1]));return"Admin"===t.permissions}return!1},n.isContributor=function(){var o=n.getToken();if(o){var t=JSON.parse(e.atob(o.split(".")[1]));return"Contributor"===t.permissions||"Admin"}return!1},n.register=function(e){return o.post("/api/register",e).success(function(o){n.saveToken(o.token)})},n.logIn=function(e){return o.post("/api/login",e).success(function(o){n.saveToken(o.token)})},n.logOut=function(){e.localStorage.removeItem("admin-token")},n.forgotPassword=function(e){return o.post("/api/forgot",e)},n.facebook=function(){var o=$q.defer();return FB.api("/me",{fields:"last_name"},function(e){!e||e.error?o.reject("Error occured"):o.resolve(e)}),o.promise},n.statusChangeCallback=function(o){console.log("statusChangeCallback"),console.log(o),"connected"===o.status?testAPI():document.getElementById("status").innerHTML="not_authorized"===o.status?"Please log into this app.":"Please log into Facebook."},n}]);