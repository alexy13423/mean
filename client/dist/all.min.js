var app=angular.module("mainApp",["templates"]);app.controller("MainCtrl",["$scope","auth","$location",function(e,o){e.user={},e.register=function(){o.register(e.user).error(function(o){e.error=o}).then(function(){window.location="http://localhost:3000/user/#/home"})},e.logIn=function(){o.logIn(e.login).error(function(o){e.error=o}).then(function(){window.location="http://localhost:3000/user/#/home"}),mixpanel.track("User Log-in",{area:"home",page:"home",action:"log-in"})},e.forgotPassword=function(){o.forgotPassword(e.forgot).success(function(o){e.forgot={},e.success=!0,console.log(o.message)}).error(function(o){e.error=o}),mixpanel.track("User Reset Password",{area:"home",page:"home",action:"resetPassword"})},e.checkLoginState=function(){o.facebook(user._id),FB.getLoginStatus(function(e){statusChangeCallback(e)})},e.isLoggedIn=o.isLoggedIn,e.currentUser=o.currentUser,e.logOut=o.logOut}]),app.factory("auth",["$http","$window",function(e,o){var t={};return t.saveToken=function(e){o.localStorage["admin-token"]=e},t.getToken=function(){return o.localStorage["admin-token"]},t.isLoggedIn=function(){var e=t.getToken();if(e){var n=JSON.parse(o.atob(e.split(".")[1]));return n.exp>Date.now()/1e3}return!1},t.currentUser=function(){if(t.isLoggedIn()){var e=t.getToken(),n=JSON.parse(o.atob(e.split(".")[1]));return n.username}},t.register=function(o){return e.post("/api/register",o).success(function(e){t.saveToken(e.token)})},t.logIn=function(o){return e.post("/api/login",o).success(function(e){t.saveToken(e.token)})},t.logOut=function(){o.localStorage.removeItem("admin-token")},t.forgotPassword=function(o){return e.post("/api/forgot",o)},t.facebook=function(){var e=$q.defer();return FB.api("/me",{fields:"last_name"},function(o){!o||o.error?e.reject("Error occured"):e.resolve(o)}),e.promise},t.statusChangeCallback=function(e){console.log("statusChangeCallback"),console.log(e),"connected"===e.status?testAPI():document.getElementById("status").innerHTML="not_authorized"===e.status?"Please log into this app.":"Please log into Facebook."},t}]),app.factory("facebookService",["$q",function(e){facebookServce.getMyLastName=function(){var o=e.defer();return FB.api("/me",{fields:"last_name"},function(e){!e||e.error?o.reject("Error occured"):o.resolve(e)}),o.promise}}]);